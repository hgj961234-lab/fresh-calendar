// 업데이트 확인용 주석
import React, { useState, useEffect } from 'react';
import { 
  Calendar, Plus, ChefHat, Refrigerator, ChevronLeft, ChevronRight, AlertCircle, 
  Check, X, Search, Clock, ArrowRight, Trash2, RefreshCcw, CheckSquare, Square, 
  BarChart2, TrendingUp, AlertTriangle, ShoppingCart, Edit2, Snowflake, Archive, 
  BookOpen, ArrowLeft, Users, LogOut, Loader, Bell, PieChart, DollarSign, Undo2,
  Utensils, Filter, SlidersHorizontal, Download, 
  // 👇 지도 보기 및 메뉴 전환용 아이콘 추가
  Moon, Sun, MonitorPlay, LayoutGrid, Menu
} from 'lucide-react';
import { Toaster, toast } from 'react-hot-toast'; // 👈 [추가] 토스트 알림

// --- FIREBASE IMPORTS ---
import { initializeApp, getApps, getApp } from "firebase/app";
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  signOut, 
  onAuthStateChanged 
} from "firebase/auth";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  query,
  writeBatch,
  getDocs,    // 👈 여기에 getDocs가 추가되었습니다.
  orderBy     // 👈 (추가 권장) history 쿼리에서 orderBy를 쓰고 있으므로 이것도 필요합니다.
} from "firebase/firestore";

// ⚠️ 사용자 제공 Firebase 설정값
const firebaseConfig = {
  apiKey: "AIzaSyA8k03QUr1vTjiNLe1EhZpPTy4PVoqM808",
  authDomain: "fresh-calendar-107af.firebaseapp.com",
  projectId: "fresh-calendar-107af",
  storageBucket: "fresh-calendar-107af.firebasestorage.app",
  messagingSenderId: "632775280248",
  appId: "1:632775280248:web:90372fb81e94e252d1cf8d",
  measurementId: "G-Y3J452QS51"
};

// Firebase 초기화
let app, auth, db;
try {
  // 👇 [수정] 앱이 이미 있으면 가져오고, 없으면 초기화 (Strict Mode 안전장치)
  app = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} catch (e) {
  console.error("Firebase Init Error:", e);
}

// ------------------------------------------------------------------
// ✂️✂️✂️ [DATA PLACEHOLDER] ✂️✂️✂️
// 아래의 세 변수(SHELF_LIFE_DB, RECIPE_FULL_DB, MOCK_USAGE_HISTORY)에 
// 기존에 가지고 계신 긴 데이터를 덮어씌워주세요.
// ------------------------------------------------------------------

// --- 유통기한 및 평균 시세 데이터베이스 (2025년 한국 물가 반영 / 단위: 원) ---
const SHELF_LIFE_DB = {
  // 김치류 (가격 현실화: 국산 기준 상향)
  '배추김치': { fridge: 90, freezer: 0, price: 28000, unit: '5kg', risk: { danger: 7, warning: 14 } }, 
  '부추김치': { fridge: 30, freezer: 0, price: 15000, unit: '1kg', risk: { danger: 5, warning: 10 } },
  '파김치': { fridge: 60, freezer: 0, price: 16000, unit: '1kg', risk: { danger: 7, warning: 14 } },
  '깍두기': { fridge: 90, freezer: 0, price: 13000, unit: '2kg', risk: { danger: 7, warning: 14 } },
  '김치': { fridge: 90, freezer: 0, price: 15000, unit: '2kg', risk: { danger: 7, warning: 14 } }, 

  // 고기류 (600g 한 근 기준 / 물가 상승 반영)
  '돼지고기': { fridge: 3, freezer: 30, price: 14800, unit: '600g', risk: { danger: 1, warning: 2 } }, 
  '소고기': { fridge: 3, freezer: 30, price: 38000, unit: '600g', risk: { danger: 1, warning: 2 } }, 
  '닭고기': { fridge: 2, freezer: 90, price: 7500, unit: '1kg', risk: { danger: 1, warning: 2 } }, 
  '오리훈제': { fridge: 14, freezer: 180, price: 13500, unit: '600g', risk: { danger: 2, warning: 5 } },
  '양고기': { fridge: 3, freezer: 180, price: 28000, unit: '600g', risk: { danger: 1, warning: 2 } },
  '다짐육': { fridge: 2, freezer: 30, price: 9500, unit: '600g', risk: { danger: 1, warning: 2 } },

  // 가공육 & 햄 & 통조림
  '베이컨': { fridge: 14, freezer: 60, price: 9800, unit: '200g', risk: { danger: 2, warning: 4 } },
  '햄': { fridge: 14, freezer: 60, price: 4500, unit: '200g', risk: { danger: 2, warning: 4 } },
  '소시지': { fridge: 14, freezer: 60, price: 8500, unit: '300g', risk: { danger: 3, warning: 7 } },
  '맛살': { fridge: 7, freezer: 0, price: 3500, unit: '150g', risk: { danger: 2, warning: 4 } },
  '어묵': { fridge: 6, freezer: 90, price: 3000, unit: '300g', risk: { danger: 2, warning: 4 } },
  '참치캔': { pantry: 1095, price: 2900, unit: '150g', risk: { danger: 30, warning: 60 } },
  '스팸': { pantry: 1095, price: 6500, unit: '200g', risk: { danger: 30, warning: 60 } },

  // 해산물
  '고등어': { fridge: 2, freezer: 90, price: 6000, unit: '1마리', risk: { danger: 1, warning: 2 } },
  '연어': { fridge: 2, freezer: 90, price: 22000, unit: '300g', risk: { danger: 1, warning: 2 } },
  '새우': { fridge: 2, freezer: 180, price: 13000, unit: '400g', risk: { danger: 1, warning: 2 } },
  '오징어': { fridge: 2, freezer: 180, price: 9000, unit: '2마리', risk: { danger: 1, warning: 2 } },
  '바지락': { fridge: 2, freezer: 90, price: 5000, unit: '800g', risk: { danger: 1, warning: 2 } },
  '해물믹스': { fridge: 2, freezer: 180, price: 11000, unit: '500g', risk: { danger: 1, warning: 2 } },
  '김': { pantry: 180, price: 6000, unit: '16봉', risk: { danger: 7, warning: 14 } },
  '미역': { pantry: 365, price: 3500, unit: '100g', risk: { danger: 30, warning: 60 } },
  '멸치': { pantry: 90, freezer: 365, price: 12000, unit: '500g', risk: { danger: 7, warning: 14 } },

  // 유제품 & 계란
  '우유': { fridge: 10, freezer: 30, price: 2980, unit: '1L', risk: { danger: 2, warning: 4 } }, 
  '달걀': { fridge: 25, freezer: 0, price: 8500, unit: '30구', risk: { danger: 3, warning: 7 } }, 
  '계란': { fridge: 25, freezer: 0, price: 8500, unit: '30구', risk: { danger: 3, warning: 7 } }, 
  '요거트': { fridge: 10, freezer: 30, price: 4500, unit: '4개', risk: { danger: 2, warning: 5 } },
  '치즈': { fridge: 30, freezer: 180, price: 5800, unit: '10장', risk: { danger: 3, warning: 7 } },
  '모짜렐라치즈': { fridge: 7, freezer: 90, price: 12000, unit: '1kg', risk: { danger: 2, warning: 5 } },
  '생크림': { fridge: 7, freezer: 30, price: 6500, unit: '500ml', risk: { danger: 2, warning: 4 } },
  '버터': { fridge: 90, freezer: 365, price: 11000, unit: '450g', risk: { danger: 7, warning: 14 } },

  // 채소 & 농산물 (신선식품 가격 변동 반영)
  '두부': { fridge: 7, freezer: 90, price: 1800, unit: '1모', risk: { danger: 1, warning: 3 } },
  '순두부': { fridge: 7, freezer: 0, price: 1200, unit: '350g', risk: { danger: 1, warning: 3 } },
  '콩나물': { fridge: 5, freezer: 0, price: 1800, unit: '300g', risk: { danger: 1, warning: 3 } },
  '숙주': { fridge: 3, freezer: 0, price: 1800, unit: '300g', risk: { danger: 1, warning: 2 } },
  '양파': { fridge: 14, freezer: 180, price: 5000, unit: '1.5kg', risk: { danger: 3, warning: 5 } }, 
  '감자': { fridge: 30, freezer: 365, price: 6000, unit: '1kg', risk: { danger: 5, warning: 10 } },
  '마늘': { fridge: 30, freezer: 365, price: 5000, unit: '500g', risk: { danger: 5, warning: 10 } },
  '다진마늘': { fridge: 14, freezer: 180, price: 7000, unit: '400g', risk: { danger: 3, warning: 7 } },
  '대파': { fridge: 14, freezer: 180, price: 3800, unit: '1단', risk: { danger: 3, warning: 5 } },
  '쪽파': { fridge: 7, freezer: 90, price: 4500, unit: '1단', risk: { danger: 2, warning: 4 } },
  '부추': { fridge: 5, freezer: 90, price: 3000, unit: '1단', risk: { danger: 2, warning: 3 } },
  '오이': { fridge: 7, freezer: 0, price: 1500, unit: '1개', risk: { danger: 2, warning: 4 } },
  '양배추': { fridge: 30, freezer: 90, price: 4000, unit: '1통', risk: { danger: 5, warning: 10 } },
  '당근': { fridge: 21, freezer: 365, price: 3000, unit: '1kg', risk: { danger: 3, warning: 7 } },
  '무': { fridge: 14, freezer: 90, price: 3000, unit: '1개', risk: { danger: 3, warning: 6 } },
  '단무지': { fridge: 30, price: 3500, unit: '400g', risk: { danger: 5, warning: 10 } },
  '애호박': { fridge: 7, freezer: 90, price: 1800, unit: '1개', risk: { danger: 2, warning: 4 } },
  '토마토': { fridge: 10, freezer: 90, price: 6000, unit: '1kg', risk: { danger: 2, warning: 5 } },
  '고수': { fridge: 5, freezer: 30, price: 3000, unit: '50g', risk: { danger: 1, warning: 3 } },
  '바질': { fridge: 5, freezer: 90, price: 3000, unit: '30g', risk: { danger: 1, warning: 3 } },
  '청양고추': { fridge: 7, freezer: 90, price: 2500, unit: '150g', risk: { danger: 2, warning: 5 } },
  '버섯': { fridge: 5, freezer: 30, price: 3000, unit: '200g', risk: { danger: 2, warning: 3 } },
  '시금치': { fridge: 3, freezer: 90, price: 3500, unit: '1단', risk: { danger: 1, warning: 2 } },
  '깻잎': { fridge: 5, freezer: 0, price: 1800, unit: '30장', risk: { danger: 1, warning: 3 } },
  '상추': { fridge: 5, freezer: 0, price: 2500, unit: '200g', risk: { danger: 1, warning: 3 } },
  '양상추': { fridge: 5, freezer: 0, price: 3500, unit: '1통', risk: { danger: 1, warning: 3 } },
  '아보카도': { fridge: 5, freezer: 90, price: 3000, unit: '1개', risk: { danger: 2, warning: 4 } },

  // 과일
  '사과': { fridge: 21, freezer: 0, price: 18000, unit: '5개', risk: { danger: 3, warning: 7 } }, 
  '바나나': { fridge: 5, freezer: 90, price: 4500, unit: '1송이', risk: { danger: 1, warning: 2 } },
  '딸기': { fridge: 3, freezer: 180, price: 14000, unit: '500g', risk: { danger: 1, warning: 2 } },
  '귤': { fridge: 14, freezer: 0, price: 12000, unit: '3kg', risk: { danger: 3, warning: 6 } },
  '레몬': { fridge: 21, freezer: 90, price: 1200, unit: '1개', risk: { danger: 5, warning: 10 } },
  '라임': { fridge: 21, freezer: 90, price: 1800, unit: '1개', risk: { danger: 5, warning: 10 } },

  // 곡류 & 면류 & 떡
  '밥': { fridge: 3, freezer: 30, price: 1600, unit: '210g', risk: { danger: 1, warning: 2 } }, 
  '쌀': { pantry: 365, price: 45000, unit: '10kg', risk: { danger: 30, warning: 60 } },
  '식빵': { pantry: 3, freezer: 30, price: 3800, unit: '1봉', risk: { danger: 1, warning: 2 } },
  '떡': { fridge: 3, freezer: 90, price: 4500, unit: '400g', risk: { danger: 1, warning: 3 } },
  '소면': { pantry: 365, price: 3500, unit: '900g', risk: { danger: 30, warning: 60 } },
  '당면': { pantry: 365, price: 4500, unit: '500g', risk: { danger: 30, warning: 60 } },
  '파스타면': { pantry: 365, price: 3500, unit: '500g', risk: { danger: 30, warning: 60 } },
  '우동면': { fridge: 30, freezer: 180, price: 3500, unit: '5개', risk: { danger: 5, warning: 10 } },
  '라면': { pantry: 180, price: 5000, unit: '5개', risk: { danger: 14, warning: 30 } },
  '중화면': { fridge: 7, freezer: 60, price: 3500, unit: '3개', risk: { danger: 2, warning: 4 } },
  '쌀국수': { pantry: 365, price: 3500, unit: '300g', risk: { danger: 30, warning: 60 } },
  '또띠아': { fridge: 7, freezer: 90, price: 4500, unit: '12장', risk: { danger: 2, warning: 5 } },
  '바게트': { pantry: 2, freezer: 30, price: 4000, unit: '1개', risk: { danger: 1, warning: 2 } },
  '빵가루': { pantry: 90, freezer: 180, price: 3000, unit: '500g', risk: { danger: 7, warning: 14 } },

  // 소스 & 양념 (병/팩 단위)
  '간장': { pantry: 180, fridge: 365, price: 6500, unit: '1L', risk: { danger: 30, warning: 60 } },
  '고추장': { fridge: 365, price: 9000, unit: '1kg', risk: { danger: 30, warning: 60 } },
  '된장': { fridge: 365, price: 9000, unit: '1kg', risk: { danger: 30, warning: 60 } },
  '쌈장': { fridge: 180, price: 4500, unit: '500g', risk: { danger: 14, warning: 30 } },
  '고춧가루': { freezer: 365, pantry: 90, price: 18000, unit: '500g', risk: { danger: 14, warning: 30 } },
  '설탕': { pantry: 730, price: 3500, unit: '1kg', risk: { danger: 60, warning: 120 } },
  '소금': { pantry: 1825, price: 2500, unit: '1kg', risk: { danger: 60, warning: 120 } },
  '후추': { pantry: 365, price: 4500, unit: '50g', risk: { danger: 30, warning: 60 } },
  '식초': { pantry: 365, price: 3000, unit: '900ml', risk: { danger: 30, warning: 60 } },
  '맛술': { pantry: 180, price: 3800, unit: '900ml', risk: { danger: 14, warning: 30 } },
  '참기름': { pantry: 90, price: 9000, unit: '350ml', risk: { danger: 14, warning: 30 } },
  '들기름': { pantry: 90, price: 13000, unit: '350ml', risk: { danger: 14, warning: 30 } },
  '식용유': { pantry: 365, price: 5500, unit: '900ml', risk: { danger: 30, warning: 60 } },
  '올리브오일': { pantry: 365, price: 13000, unit: '500ml', risk: { danger: 30, warning: 60 } },
  '굴소스': { fridge: 180, price: 5000, unit: '350g', risk: { danger: 14, warning: 30 } },
  '마요네즈': { fridge: 90, price: 4500, unit: '500g', risk: { danger: 7, warning: 14 } },
  '케찹': { fridge: 90, price: 3500, unit: '500g', risk: { danger: 7, warning: 14 } },
  '머스타드': { fridge: 180, price: 3500, unit: '250g', risk: { danger: 14, warning: 30 } },
  '칠리소스': { fridge: 180, price: 4500, unit: '300g', risk: { danger: 14, warning: 30 } },
  '토마토소스': { fridge: 5, price: 5500, unit: '600g', risk: { danger: 2, warning: 3 } },
  '크림소스': { fridge: 3, price: 5500, unit: '350g', risk: { danger: 1, warning: 2 } },
  '카레': { pantry: 365, price: 3800, unit: '100g', risk: { danger: 30, warning: 60 } },
  '전분': { pantry: 365, price: 2500, unit: '400g', risk: { danger: 30, warning: 60 } },
  '밀가루': { pantry: 180, price: 2800, unit: '1kg', risk: { danger: 14, warning: 30 } },
  '부침가루': { pantry: 180, price: 2800, unit: '1kg', risk: { danger: 14, warning: 30 } },
  '튀김가루': { pantry: 180, price: 2800, unit: '1kg', risk: { danger: 14, warning: 30 } },
  '다시다': { pantry: 365, price: 5500, unit: '300g', risk: { danger: 30, warning: 60 } },
  '액젓': { pantry: 365, price: 5500, unit: '1kg', risk: { danger: 30, warning: 60 } },
  '육수': { fridge: 3, freezer: 30, price: 1800, unit: '500g', risk: { danger: 1, warning: 2 } },
  '물엿': { pantry: 365, price: 3500, unit: '700g', risk: { danger: 30, warning: 60 } },
  '올리고당': { pantry: 365, price: 4500, unit: '700g', risk: { danger: 30, warning: 60 } },
   
  // [바꿀 코드] (ZONES 상수 정의 추가)
  'default': { fridge: 7, price: 3000, unit: '1개', risk: { danger: 2, warning: 4 } }
};

// 🌟 [필수 추가] 누락되었던 ZONES 상수 정의 (지도 뷰 에러 해결)
const ZONES = {
  FRIDGE_MAIN_1: '🥘 냉장실: 메인 선반 (상)',
  FRIDGE_MAIN_2: '🥘 냉장실: 메인 선반 (중)',
  FRIDGE_MAIN_3: '🥘 냉장실: 메인 선반 (하)',
  FRIDGE_FRESH_1: '🥬 냉장실: 신선야채실 (좌)',
  FRIDGE_FRESH_2: '🥬 냉장실: 신선야채실 (우)',
  FRIDGE_MULTI_1: '🥓 냉장실: 멀티수납코너 (좌)',
  FRIDGE_MULTI_2: '🥓 냉장실: 멀티수납코너 (우)',
  FRIDGE_DOOR_LEFT_1: '🚪 냉장실: 좌측 도어 (상)',
  FRIDGE_DOOR_LEFT_2: '🚪 냉장실: 좌측 도어 (중)',
  FRIDGE_DOOR_LEFT_3: '🚪 냉장실: 좌측 도어 (하)',
  FRIDGE_DOOR_RIGHT_1: '🚪 냉장실: 우측 도어 (상)',
  FRIDGE_DOOR_RIGHT_2: '🚪 냉장실: 우측 도어 (중)',
  FRIDGE_DOOR_RIGHT_3: '🚪 냉장실: 우측 도어 (하)',
  FREEZER_LEFT_1: '❄️ 냉동실: 좌측 서랍 (상)',
  FREEZER_LEFT_2: '❄️ 냉동실: 좌측 서랍 (중)',
  FREEZER_LEFT_3: '❄️ 냉동실: 좌측 서랍 (하)',
  FREEZER_RIGHT_1: '❄️ 냉동실: 우측 서랍 (상)',
  FREEZER_RIGHT_2: '❄️ 냉동실: 우측 서랍 (중)',
  FREEZER_RIGHT_3: '❄️ 냉동실: 우측 서랍 (하)',
  PANTRY: '🏠 실온: 다용도실/팬트리'
};

// 🌟 [신규] LG 4도어 냉장고 맞춤 위치 추천 알고리즘 (도어 3단 분할 적용 완료)
const getRecommendedZone = (name, category) => {
  const n = name.replace(/\s/g, ''); // 공백 제거하여 매칭 정확도 향상

  // ------------------------------------------------
  // 1. 🏠 실온/팬트리 (Pantry)
  // ------------------------------------------------
  if (category === 'pantry') return '🏠 실온: 다용도실/팬트리';

  // ------------------------------------------------
  // 2. ❄️ 냉동실 (Freezer) - 하단
  // ------------------------------------------------
  if (category === 'freezer') {
    // ❄️ [냉동] 좌측 도어 (조리용 양념/채소)
    // (상) 작고 자주 쓰는 큐브형 양념
    if (['다진마늘', '마늘', '생강', '고추', '청양고추', '큐브'].some(k => n.includes(k)))
      return '❄️ 냉동실: 좌측 도어 (상)';
    // (하) 부피가 큰 봉지형 양념/채소
    if (['대파', '쪽파', '고춧가루', '파'].some(k => n.includes(k)))
      return '❄️ 냉동실: 좌측 도어 (하)';

    // ❄️ [냉동] 우측 도어 (간식/가루/빵)
    // (상) 아이스크림, 작게 소분된 것
    if (['아이스크림', '버터', '치즈', '견과류', '아몬드', '호두'].some(k => n.includes(k)))
      return '❄️ 냉동실: 우측 도어 (상)';
    // (하) 빵, 떡, 가루 등 부피 큰 것
    if (['떡', '빵', '식빵', '바게트', '또띠아', '피자', '얼음', '가루', '전분', '밀가루', '튀김가루'].some(k => n.includes(k)))
      return '❄️ 냉동실: 우측 도어 (하)';
    
    // ❄️ [냉동] 좌측 서랍 (육류 위주)
    // 상: 얇은 고기, 가공육 (빨리 먹거나 작은 것)
    if (['베이컨', '소시지', '햄', '다짐육', '차돌', '대패'].some(k => n.includes(k))) 
      return '❄️ 냉동실: 좌측 서랍 (상)';
    // 중: 메인 육류 (부피 큰 것)
    if (['고기', '소고기', '돼지', '삼겹살', '목살', '닭', '오리', '양고기', '스테이크'].some(k => n.includes(k))) 
      return '❄️ 냉동실: 좌측 서랍 (중)';
    // 하: 장기 보관 육류, 뼈, 사골 (무거운 것)
    if (['사골', '잡뼈', '육수', '곰탕'].some(k => n.includes(k))) 
      return '❄️ 냉동실: 좌측 서랍 (하)';

    // ❄️ [냉동] 우측 서랍 (해산물/건어물 위주)
    // 상: 작은 해산물, 조개류
    if (['새우', '오징어', '낙지', '쭈꾸미', '바지락', '조개', '해물', '굴'].some(k => n.includes(k))) 
      return '❄️ 냉동실: 우측 서랍 (상)';
    // 중: 생선류 (부피 큰 것)
    if (['생선', '고등어', '연어', '갈치', '조기', '동태', '참치'].some(k => n.includes(k))) 
      return '❄️ 냉동실: 우측 서랍 (중)';
    // 하: 건어물, 다시용 재료
    if (['멸치', '건어물', '김', '미역', '다시마', '황태', '쥐포'].some(k => n.includes(k))) 
      return '❄️ 냉동실: 우측 서랍 (하)';
    
    // 냉동 기본값: 찾기 쉽게 우측 상단 서랍
    return '❄️ 냉동실: 우측 서랍 (상)'; 
  }

  // ------------------------------------------------
  // 3. 🧊 냉장실 (Fridge) - 상단
  // ------------------------------------------------

  // 🚪 [냉장] 좌측 도어 (소스/양념류) - 3단 분할
  // (상) 작고 가벼운 튜브/병
  if (['와사비', '연겨자', '시럽', '핫소스', '바닐라', '약'].some(k => n.includes(k)))
    return '🚪 냉장실: 좌측 도어 (상)';
  // (중) 가장 자주 쓰는 소스류 (손이 잘 닿는 곳)
  if (['케찹', '케첩', '마요네즈', '드레싱', '머스타드', '잼', '소스', '양념'].some(k => n.includes(k)))
    return '🚪 냉장실: 좌측 도어 (중)';
  // (하) 무거운 장류, 큰 병
  if (['고추장', '된장', '쌈장', '굴소스', '액젓', '간장', '다진마늘', '장아찌'].some(k => n.includes(k)))
    return '🚪 냉장실: 좌측 도어 (하)';

  // 🚪 [냉장] 우측 도어 (음료/유제품) - 3단 분할
  // (상) 가벼운 유제품, 치즈
  if (['치즈', '버터', '크림치즈', '요거트', '유산균', '생크림', '야쿠르트'].some(k => n.includes(k)))
    return '🚪 냉장실: 우측 도어 (상)';
  // (중) 자주 마시는 음료 (우유, 주스)
  if (['우유', '주스', '콜라', '사이다', '캔맥주', '음료', '두유'].some(k => n.includes(k)))
    return '🚪 냉장실: 우측 도어 (중)';
  // (하) 무거운 물병, 주류
  if (['물', '생수', '맥주', '소주', '와인', '대용량'].some(k => n.includes(k)))
    return '🚪 냉장실: 우측 도어 (하)';


  // 🥬 [냉장] 신선야채실 (하단 서랍)
  // 좌측: 잎채소, 뿌리채소, 요리용 채소
  if (['상추','깻잎','시금치','콩나물','숙주','오이','당근','무','양배추','양상추','파','대파','쪽파','고추','청양고추','피망','브로콜리','부추','채소','야채','버섯','애호박','단무지','고수','바질','감자','양파','마늘'].some(k => n.includes(k))) 
    return '🥬 냉장실: 신선야채실 (좌)';
  // 우측: 과일류 (채소와 분리하여 에틸렌 가스 영향 최소화)
  if (['사과','배','포도','딸기','귤','바나나','레몬','라임','아보카도','토마토','수박','멜론','참외','과일','복숭아','자두'].some(k => n.includes(k))) 
    return '🥬 냉장실: 신선야채실 (우)';
  
  // 🥓 [냉장] 멀티 수납 코너 (자투리 공간/신선맞춤)
  // 좌측: 햄, 치즈, 버터, 작은 가공식품
  if (['햄','베이컨','소시지','맛살','어묵','치즈','모짜렐라','버터','자투리','유부'].some(k => n.includes(k))) 
    return '🥓 냉장실: 멀티수납코너 (좌)';
  // 우측: 계란 (전용 트레이 가정)
  if (['계란','달걀','메추리알'].some(k => n.includes(k))) 
    return '🥓 냉장실: 멀티수납코너 (우)';

  // 🥘 [냉장] 메인 선반
  // 하단: 김치, 장류, 무거운 것 (가장 시원하고 안정적)
  if (['김치','깍두기','장아찌','동치미','된장','고추장','수박','쌀','잡곡'].some(k => n.includes(k))) 
    return '🥘 냉장실: 메인 선반 (하)';
  
  // 중단: 반찬, 찌개, 두부, 어묵 (가장 손이 많이 가는 위치)
  if (['반찬','찌개','국','두부','순두부','콩나물','어묵','나물','장조림','멸치볶음'].some(k => n.includes(k))) 
    return '🥘 냉장실: 메인 선반 (중)';
  
  // 상단: 남은 음식, 빨리 먹어야 하는 것, 밥, 면류
  // 신선육(냉장고기)는 신선실이나 하단이 좋지만, 보통 빨리 요리하려고 잘 보이는 곳에 둠.
  // 여기서는 '기본값'으로 처리되거나 상단으로 배정.
  if (['밥','면','우동','중화면','또띠아','케이크','디저트'].some(k => n.includes(k)))
    return '🥘 냉장실: 메인 선반 (상)';

  // ❄️ [특수] 냉장실에 보관하는 신선 육류/해산물 (냉동 아님)
  // 보통 신선야채실 옆이나 메인 하단(가장 차가운 곳)에 둠 -> 메인 선반 (하) 추천
  if (['고기','소고기','돼지','닭','오리','양고기','다짐육','생선','연어'].some(k => n.includes(k)))
    return '🥘 냉장실: 메인 선반 (하)';

  // 그 외 모든 냉장 식재료 기본값
  return '🥘 냉장실: 메인 선반 (상)';
};

// --- 레시피 데이터베이스 (60종 - 상세 버전 & 재료 동기화) ---
const RECIPE_FULL_DB = [
  // --- 한식 (1-20) ---
  {
    id: 1, category: 'Korean', name: '김치찌개',
    ingredients: ['김치', '돼지고기', '두부', '대파', '양파', '다진마늘', '고춧가루', '설탕', '간장', '육수', '식용유'],
    measure: '잘 익은 신김치 180g, 돼지고기(앞다리살/목살) 120g, 양파 1/4개, 두부 1/3모, 대파 15cm, 다진마늘 1T, 고춧가루 1T, 설탕 0.3T, 국간장 1T, 멸치육수 400ml, 식용유 1T',
    steps: [
      '1. [돼지고기 지방 활용] 냄비에 식용유 1T를 두르고 돼지고기를 볶습니다. 고기에서 나온 기름이 김치를 볶을 때 풍미를 폭발시킵니다.',
      '2. [김치 볶기] 고기 겉면이 하얗게 익으면 김치와 설탕 0.3T를 넣고 중불에서 "충분히" 볶습니다. 설탕은 김치의 쿰쿰한 군내를 잡고 감칠맛을 끌어올립니다.',
      '3. [육수 붓고 끓이기] 육수(또는 쌀뜨물) 400ml를 붓고 센불에서 끓입니다. 끓어오를 때 거품을 걷어내면 국물이 깔끔해집니다.',
      '4. [깊은 맛 내기] 중약불로 줄이고 양파, 다진마늘, 고춧가루, 국간장을 넣은 뒤 10분 이상 뭉근하게 끓여 김치가 투명해질 때까지 익힙니다.',
      '5. [마무리] 두부와 대파를 넣고 3분간 더 끓입니다. 마지막에 참기름 반 스푼을 두르면 고소함이 배가됩니다.'
    ]
  },
  {
    id: 2, category: 'Korean', name: '된장찌개',
    ingredients: ['된장', '애호박', '두부', '감자', '양파', '육수', '다진마늘', '고춧가루', '청양고추', '대파'],
    measure: '된장 2T, 애호박 1/4개, 두부 1/2모, 감자 1개, 양파 1/2개, 멸치육수 500ml, 다진마늘 0.5T, 고춧가루 0.5T, 청양고추 1개, 대파 10cm',
    steps: [
      '1. [된장 풀기] 멸치육수가 팔팔 끓으면 체를 이용해 된장을 곱게 풉니다. 체에 거르면 국물이 텁텁하지 않고 깔끔해집니다.',
      '2. [채소 익히는 순서] 단단한 감자를 가장 먼저 넣고 3분간 익힙니다. 감자 전분이 나와 국물이 살짝 걸쭉해지면 더 구수합니다.',
      '3. [부재료 투하] 애호박, 양파, 다진마늘, 고춧가루(칼칼함 추가)를 넣고 채소가 투명해질 때까지 5분간 끓입니다.',
      '4. [두부 타이밍] 두부는 너무 오래 끓이면 단단해지므로 마무리 3분 전에 넣습니다.',
      '5. [화룡점정] 대파와 송송 썬 청양고추를 넣고 한소끔(1분)만 더 끓여 향을 살린 뒤 불을 끕니다.'
    ]
  },
  {
    id: 3, category: 'Korean', name: '순두부찌개',
    ingredients: ['순두부', '바지락', '다짐육', '대파', '양파', '계란', '고춧가루', '식용유', '참기름', '간장', '다진마늘'],
    measure: '순두부 1봉, 바지락 200g, 다진 돼지고기 50g, 대파 1/2대, 양파 1/4개, 계란 1개, 고춧가루 2T, 식용유 2T, 참기름 1T, 국간장 1T, 다진마늘 1T',
    steps: [
      '1. [고추기름 비법] 냄비에 식용유 2T와 참기름 1T를 섞어 두르고 대파와 고기를 볶습니다. 파 향이 올라오면 불을 끄거나 아주 약하게 줄이고 고춧가루 2T를 볶아 타지 않게 고추기름을 냅니다.',
      '2. [육수 끓이기] 고추기름이 빨갛게 나오면 물 300ml를 붓고 센불로 올립니다.',
      '3. [감칠맛 더하기] 육수가 끓으면 바지락, 다진마늘, 양파, 국간장을 넣습니다. 바지락이 입을 벌릴 때까지 끓여 시원한 맛을 냅니다.',
      '4. [순두부 넣기] 순두부를 봉지째 반으로 잘라 큼직하게 넣고 숟가락으로 숭덩숭덩 자릅니다. 너무 휘젓지 않아야 지저분해지지 않습니다.',
      '5. [마무리] 뚝배기가 보글보글 끓을 때 계란 하나를 톡 깨뜨려 넣고 잔열로 익혀 부드럽게 즐깁니다.'
    ]
  },
  {
    id: 4, category: 'Korean', name: '미역국',
    ingredients: ['미역', '소고기', '참기름', '간장', '다진마늘', '액젓', '소금'],
    measure: '건미역 20g, 소고기 국거리 150g, 참기름 2T, 국간장 2T, 다진마늘 1T, 액젓 1T, 물 1.5L, 소금',
    steps: [
      '1. [미역 볶기] 불린 미역의 물기를 꽉 짠 뒤, 냄비에 참기름과 소고기, 미역, 국간장 2T를 넣고 중불에서 5분간 "달달" 볶습니다. 미역이 초록색으로 변하고 간이 배어야 국물이 진국이 됩니다.',
      '2. [물 붓기] 물 1.5L를 붓고 센불에서 팔팔 끓입니다. 이때 떠오르는 거품은 걷어내야 국물이 맑습니다.',
      '3. [오래 끓이기] 국물이 끓으면 중약불로 줄이고 다진마늘과 액젓 1T를 넣습니다. 최소 20분 이상 뚜껑 덮고 뭉근하게 끓여야 미역이 보들보들해집니다.',
      '4. [간 맞추기] 액젓(멸치/까나리)을 넣으면 감칠맛이 폭발합니다. 부족한 간은 소금으로 맞춰 깔끔하게 마무리합니다.'
    ]
  },
  {
    id: 5, category: 'Korean', name: '삼계탕',
    ingredients: ['닭고기', '찹쌀', '마늘', '대추', '인삼', '대파', '소금', '후추'],
    measure: '영계 1마리(500g), 불린 찹쌀, 통마늘 6알, 대추 4알, 수삼 1뿌리, 삼계탕용 한방팩, 대파, 소금, 후추',
    steps: [
      '1. [닭 손질] 닭 날개 끝과 꽁지 부분의 노란 기름덩어리를 가위로 제거해야 국물에 잡내가 없습니다. 뱃속 핏물도 깨끗이 씻어주세요.',
      '2. [속 채우기] 뱃속에 불린 찹쌀, 통마늘, 대추, 인삼을 80%만 채웁니다(찹쌀이 익으면서 불어남). 다리 한쪽에 칼집을 내어 꼬아주면 내용물이 빠지지 않습니다.',
      '3. [끓이기] 냄비에 닭이 잠길 정도의 물과 한방팩을 넣고 센불에서 10분간 끓이며 거품을 걷어냅니다.',
      '4. [푹 삶기] 뚜껑을 덮고 중약불에서 40~50분간 푹 삶습니다. 젓가락으로 닭 가슴살을 찔렀을 때 핏물이 안 나오면 다 익은 것입니다.',
      '5. [서빙] 그릇에 담고 송송 썬 대파를 듬뿍 올린 뒤 소금, 후추를 곁들입니다.'
    ]
  },
  {
    id: 6, category: 'Korean', name: '불고기',
    ingredients: ['소고기', '양파', '당근', '대파', '버섯', '간장', '설탕', '다진마늘', '맛술', '참기름'],
    measure: '소고기 불고기용 600g, 양파 1/2개, 당근, 대파, 버섯, 진간장 6T, 설탕 3T, 다진마늘 2T, 맛술 2T, 참기름 1T, 배 음료(선택)',
    steps: [
      '1. [핏물 제거] 소고기는 키친타월로 눌러 핏물을 닦아내야 누린내가 나지 않습니다.',
      '2. [연육 작용] 갈아만든 배 음료나 설탕 3T를 고기에 먼저 버무려 10분간 두면 육질이 훨씬 부드러워집니다.',
      '3. [양념 재우기] 간장, 마늘, 맛술, 참기름 등 나머지 양념을 넣고 버무려 최소 30분간 냉장 숙성합니다.',
      '4. [센불 볶기] 달군 팬에 고기를 넣고 "센불"에서 볶아야 물이 생기지 않고 불맛이 납니다. 고기가 반쯤 익으면 채소(양파, 당근, 버섯)를 넣고 볶습니다.',
      '5. [마무리] 국물이 자작하게 졸아들면 통깨를 뿌려 완성합니다.'
    ]
  },
  {
    id: 7, category: 'Korean', name: '제육볶음',
    ingredients: ['돼지고기', '양파', '대파', '당근', '고추장', '고춧가루', '간장', '설탕', '다진마늘', '맛술', '참기름'],
    measure: '돼지고기 앞다리살 600g, 양파 1개, 대파 1대, 당근, 고추장 3T, 고춧가루 3T, 간장 3T, 설탕 2T, 다진마늘 2T, 맛술 2T, 참기름 1T',
    steps: [
      '1. [설탕 코팅] 고기를 먹기 좋게 썰어 설탕 2T를 먼저 넣고 조물조물 버무립니다. 설탕 분자가 작아 고기에 단맛이 가장 먼저 배어듭니다.',
      '2. [양념장 숙성] 나머지 양념 재료를 섞어 고기에 넣고 20분간 재워둡니다.',
      '3. [볶기] 팬에 식용유를 두르고 고기를 넣어 중센불에서 타지 않게 볶습니다. 양념 때문에 타기 쉬우니 자주 뒤적여주세요.',
      '4. [물 한 컵의 기적] 고기가 반쯤 익었을 때 물을 소주잔 반 컵 정도 넣으면 양념이 타지 않고 고기가 촉촉하게 속까지 익습니다.',
      '5. [채소 넣기] 고기가 거의 다 익으면 양파, 대파, 당근을 넣고 센불에서 빠르게 볶아 채소의 아삭함을 살립니다.'
    ]
  },
  {
    id: 8, category: 'Korean', name: '갈비찜',
    ingredients: ['소고기', '무', '당근', '버섯', '간장', '설탕', '맛술', '다진마늘', '대파', '참기름'],
    measure: '소갈비 1kg, 무 1/3개, 당근 1/2개, 표고버섯, 간장 1컵, 설탕 0.5컵, 맛술 0.5컵, 다진마늘 0.5컵, 대파 1컵, 참기름',
    steps: [
      '1. [핏물 빼기] 갈비는 찬물에 1시간 이상 담가 핏물을 빼고, 중간에 물을 2~3번 갈아줘야 잡내가 사라집니다.',
      '2. [데치기] 끓는 물에 갈비를 넣고 5분간 데친 뒤, 찬물에 하나하나 씻어 뼈 가루와 불순물을 제거합니다.',
      '3. [1차 끓이기] 냄비에 갈비, 양념장, 물 3-4컵을 붓고 뚜껑 열고 센불 20분 -> 뚜껑 덮고 중불 30분간 끓입니다.',
      '4. [채소 다듬기] 무와 당근은 모서리를 둥글게 깎아야(밤톨 모양) 끓으면서 부서져 국물이 탁해지는 것을 막습니다.',
      '5. [졸이기] 고기가 부드러워지면 채소를 넣고 국물이 자작해질 때까지 20분간 더 졸입니다. 마지막에 참기름을 둘러 윤기를 냅니다.'
    ]
  },
  {
    id: 9, category: 'Korean', name: '닭갈비',
    ingredients: ['닭고기', '양배추', '고구마', '떡', '대파', '깻잎', '고추장', '고춧가루', '간장', '설탕', '다진마늘', '카레'],
    measure: '닭다리살 500g, 양배추, 고구마, 떡, 대파, 깻잎 10장, 고추장 4T, 고춧가루 4T, 간장 4T, 설탕 3T, 다진마늘 2T, 카레가루 1t',
    steps: [
      '1. [비법 재료] 양념장에 카레가루 1작은술을 넣으면 닭 비린내를 잡고 전문점 맛을 냅니다. 닭고기에 양념을 버무려 30분 재웁니다.',
      '2. [익히는 순서] 팬에 식용유를 두르고 양념한 닭과 단단한 고구마를 먼저 넣고 중불에서 볶습니다.',
      '3. [채소 투하] 닭 겉면이 익으면 양배추, 떡, 대파를 넣습니다. 양배추에서 채수가 나와 타지 않고 볶아집니다.',
      '4. [수분 조절] 만약 양념이 타려고 하면 물을 2~3숟가락 넣어주며 볶습니다.',
      '5. [향긋한 마무리] 고구마가 다 익으면 불을 끄고 깻잎을 넣어 잔열로 섞어줍니다.'
    ]
  },
  {
    id: 10, category: 'Korean', name: '보쌈',
    ingredients: ['돼지고기', '된장', '대파', '양파', '마늘', '후추', '월계수잎', '커피'],
    measure: '통삼겹살(또는 앞다리살) 1kg, 된장 2T, 대파, 양파, 통마늘, 통후추, 월계수잎, 커피가루 1t, 물 2L',
    steps: [
      '1. [육수 끓이기] 물에 된장, 커피가루, 대파, 양파, 마늘 등 향신 채소를 넣고 먼저 팔팔 끓입니다. (찬물에 고기를 넣으면 육즙이 빠짐)',
      '2. [고기 삶기] 물이 끓으면 고기를 넣고 뚜껑을 열어 센불에서 10분간 삶아 잡내를 날립니다.',
      '3. [속까지 익히기] 뚜껑을 덮고 중불로 줄여 40~50분간 푹 삶습니다. 젓가락으로 찔러 핏물이 안 나오면 익은 것입니다.',
      '4. [뜸들이기] 불을 끄고 고기를 국물 속에 10분간 담가두면 고기가 수분을 머금어 썰었을 때 훨씬 촉촉합니다.',
      '5. [썰기] 고기를 건져 한 김 식힌 뒤(뜨거울 때 썰면 부서짐) 결 반대 방향으로 얇게 썹니다.'
    ]
  },
  {
    id: 11, category: 'Korean', name: '비빔밥',
    ingredients: ['밥', '콩나물', '시금치', '당근', '애호박', '다짐육', '계란', '고추장', '참기름', '설탕', '다진마늘'],
    measure: '밥 1공기, 콩나물, 시금치, 당근, 애호박, 다진고기 50g, 계란 1개, 고추장 2T, 설탕 1T, 참기름 1T, 다진마늘, 통깨',
    steps: [
      '1. [나물 준비] 콩나물과 시금치는 끓는 물에 살짝 데쳐 물기를 짜고 소금, 참기름, 다진마늘로 조물조물 무칩니다.',
      '2. [색감 살리기] 팬에 기름을 두르고 채 썬 당근(주황)과 애호박(초록)을 소금 간 하여 각각 볶아냅니다.',
      '3. [고기 볶음] 다진 고기는 간장, 설탕으로 짭짤하게 볶아 감칠맛을 더합니다.',
      '4. [계란 프라이] 비빔밥의 꽃, 계란 프라이는 노른자를 살린 반숙(써니사이드업)으로 익힙니다.',
      '5. [담음새] 넓은 그릇에 밥을 담고 준비한 재료들을 색깔이 겹치지 않게 돌려 담은 뒤 고추장 양념과 참기름을 곁들입니다.'
    ]
  },
  {
    id: 12, category: 'Korean', name: '김치볶음밥',
    ingredients: ['김치', '밥', '햄', '양파', '대파', '식용유', '버터', '굴소스', '설탕', '김', '계란'],
    measure: '신김치 120g, 밥 1공기(찬밥), 햄 50g, 양파, 대파, 식용유, 버터 0.5T, 굴소스 0.5T, 설탕 0.3T, 김가루, 계란',
    steps: [
      '1. [파기름] 팬에 식용유를 넉넉히 두르고 송송 썬 대파를 볶아 파기름을 냅니다. 여기에 햄을 넣고 노릇하게 볶아 맛을 냅니다.',
      '2. [김치 볶기] 다진 김치와 설탕 0.3T를 넣고 볶습니다. 김치 국물이 자작하게 졸아들 때까지 충분히 볶아야 신맛이 덜합니다.',
      '3. [양념 태우기] 김치를 한쪽으로 밀고 빈 공간에 굴소스(또는 간장)를 넣어 살짝 눌어붙게 끓인 뒤 섞으면 불맛이 납니다.',
      '4. [찬밥 활용] 불을 끄거나 약하게 줄이고 밥을 넣어 비비듯이 섞어줍니다. 다 섞이면 센불로 올려 밥알을 볶습니다.',
      '5. [버터 킥] 불을 끄기 직전에 버터 한 조각을 녹여 섞어주면 풍미가 폭발합니다. 계란 프라이와 김가루를 올려 드세요.'
    ]
  },
  {
    id: 13, category: 'Korean', name: '김밥',
    ingredients: ['김', '밥', '햄', '단무지', '맛살', '계란', '시금치', '당근', '참기름', '소금'],
    measure: '김밥김, 밥 2공기, 햄, 단무지, 맛살, 계란 2개, 시금치, 당근, 소금, 참기름, 통깨',
    steps: [
      '1. [밥 양념] 따뜻한 밥에 소금, 참기름, 통깨를 넉넉히 넣고 비벼 식힙니다. 밥만 먹어도 맛있을 정도로 간이 되어야 합니다.',
      '2. [재료 준비] 당근은 채 썰어 볶고, 계란은 지단을 부쳐 썰고, 햄과 맛살은 살짝 볶아 준비합니다. 물기 있는 재료(단무지, 시금치)는 물기를 꽉 짭니다.',
      '3. [밥 펴기] 김의 거친 면이 위로 오게 두고, 밥을 야구공만큼 덜어 김의 3/4까지 최대한 얇고 고르게 폅니다.',
      '4. [말기] 밥 위에 재료를 층층이 쌓지 말고 단무지를 중심으로 나란히 놓은 뒤, 끝에서부터 꾹꾹 눌러가며 단단하게 맙니다.',
      '5. [썰기] 칼과 김밥 겉면에 참기름을 바르고 톱질하듯 썰면 옆구리가 터지지 않습니다.'
    ]
  },
  {
    id: 14, category: 'Korean', name: '잡채',
    ingredients: ['당면', '돼지고기', '시금치', '당근', '양파', '버섯', '간장', '설탕', '참기름', '다진마늘'],
    measure: '당면 200g, 돼지고기 등심 100g, 시금치, 당근, 양파, 버섯, 간장 5T, 설탕 2T, 참기름 3T, 다진마늘 1T',
    steps: [
      '1. [재료 볶기] 채소(양파, 당근, 버섯)는 채 썰어 소금 간을 하고 밝은 색부터 순서대로 볶아 덜어둡니다. 고기는 간장 양념하여 볶습니다.',
      '2. [당면 삶기] 끓는 물에 당면을 6분간 삶습니다. 식용유를 한 방울 넣으면 서로 달라붙지 않습니다.',
      '3. [면 코팅] 삶은 당면은 물기를 빼고 팬에 간장, 설탕, 식용유를 넣어 윤기 나게 한 번 볶아주면 불지 않고 쫄깃합니다.',
      '4. [버무리기] 큰 볼에 볶은 당면과 준비한 재료, 데친 시금치를 넣습니다.',
      '5. [마무리] 참기름과 통깨를 넉넉히 넣고 뜨거울 때 골고루 버무려 완성합니다.'
    ]
  },
  {
    id: 15, category: 'Korean', name: '떡볶이',
    ingredients: ['떡', '어묵', '대파', '양배추', '고추장', '고춧가루', '설탕', '간장', '다진마늘'],
    measure: '떡볶이떡 300g, 사각어묵 2장, 대파 1대, 양배추, 물 500ml, 고추장 3T, 고춧가루 2T, 설탕 3T, 간장 2T, 다진마늘 1T',
    steps: [
      '1. [황금 비율] 물 500ml에 고추장, 고춧가루, 설탕, 간장을 넣고 끓입니다. 고춧가루를 넣어야 텁텁하지 않고 깔끔하게 맵습니다.',
      '2. [떡 먼저] 국물이 끓으면 떡을 먼저 넣습니다. 떡에 간이 배고 말랑말랑해질 때까지 중불에서 충분히 끓입니다.',
      '3. [재료 추가] 떡이 떠오르면 어묵과 양배추를 넣습니다. 어묵에서 감칠맛이 우러나옵니다.',
      '4. [농도 맞추기] 국물이 걸쭉해질 때까지 졸입니다. 이때 대파를 큼직하게 썰어 넣으면 달큰한 맛이 더해집니다.',
      '5. [팁] 라면 사리를 넣으려면 물을 1컵 더 추가하고, 마지막에 삶은 계란을 으깨 국물에 비벼 드세요.'
    ]
  },
  {
    id: 16, category: 'Korean', name: '해물파전',
    ingredients: ['쪽파', '오징어', '새우', '계란', '부침가루', '튀김가루', '식용유'],
    measure: '쪽파 200g, 오징어, 새우, 홍고추, 계란 2개, 부침가루 1컵, 튀김가루 0.5컵, 찬물, 식용유',
    steps: [
      '1. [바삭한 반죽] 부침가루와 튀김가루를 2:1로 섞고 "찬물"로 반죽하면 훨씬 바삭합니다. 반죽은 너무 되직하지 않고 주르륵 흐를 정도로 만듭니다.',
      '2. [굽기 시작] 달군 팬에 식용유를 넉넉히(튀기듯이) 두르고 반죽을 얇게 깐 뒤 쪽파를 가지런히 올립니다.',
      '3. [사이 채우기] 쪽파 사이사이에 반죽을 조금 더 뿌려 재료가 따로 놀지 않게 접착시킵니다.',
      '4. [토핑과 계란] 물기 뺀 해물을 올리고, 푼 계란물을 지그재그로 뿌려 고소함을 더합니다.',
      '5. [뒤집기] 아랫면이 완전히 노릇해지고 팬을 흔들었을 때 전이 움직이면 뒤집어서 바삭하게 익힙니다.'
    ]
  },
  {
    id: 17, category: 'Korean', name: '냉면',
    ingredients: ['냉면', '육수', '무', '오이', '계란', '식초', '겨자', '참기름'],
    measure: '냉면사리, 시판 냉면육수, 쌈무, 오이, 삶은 계란, 겨자, 식초, 통깨',
    steps: [
      '1. [육수 팁] 냉면 육수는 조리 3시간 전에 냉동실에 넣어 살얼음 상태로 만들면 전문점 맛이 납니다.',
      '2. [면 삶기] 끓는 물에 면을 넣고 40~50초간 아주 짧게 삶습니다. 면이 서로 붙지 않게 계속 저어주세요.',
      '3. [전분 빼기] 삶은 면을 건져 찬물(얼음물)에서 빨래하듯이 "빡빡" 문질러 씻어야 전분기가 빠지고 면발이 쫄깃해집니다.',
      '4. [물기 제거] 체에 받쳐 물기를 최대한 꽉 짠 뒤 그릇에 또아리를 틀어 담습니다.',
      '5. [완성] 육수를 붓고 채 썬 오이, 쌈무, 계란을 올립니다. 취향에 따라 식초, 겨자를 곁들입니다.'
    ]
  },
  {
    id: 18, category: 'Korean', name: '칼국수',
    ingredients: ['칼국수면', '육수', '바지락', '애호박', '감자', '당근', '대파', '간장', '다진마늘'],
    measure: '칼국수면, 멸치육수 600ml, 바지락 200g, 애호박, 감자, 당근, 대파, 국간장, 다진마늘',
    steps: [
      '1. [육수 내기] 멸치 육수가 끓으면 해감한 바지락을 넣고 입을 벌릴 때까지 끓인 뒤 바지락은 건져둡니다(오래 끓이면 질겨짐).',
      '2. [채소 넣기] 육수에 감자, 당근 등 단단한 채소를 먼저 넣고 끓입니다.',
      '3. [면 투하] 칼국수 면에 묻은 밀가루를 탈탈 털어내고(국물이 탁해짐 방지) 육수에 넣습니다.',
      '4. [양념] 면이 투명해지면 애호박, 다진마늘, 국간장으로 간을 합니다.',
      '5. [합체] 건져둔 바지락과 대파를 넣고 한소끔 더 끓여 완성합니다. 김가루나 후추를 뿌려드세요.'
    ]
  },
  {
    id: 19, category: 'Korean', name: '안동찜닭',
    ingredients: ['닭고기', '당면', '감자', '당근', '양파', '대파', '간장', '설탕', '맛술', '다진마늘', '커피'],
    measure: '닭볶음탕용 닭 800g, 당면, 감자, 당근, 양파, 대파, 건고추, 진간장 1/2컵, 흑설탕 1/2컵, 맛술, 다진마늘, 커피가루',
    steps: [
      '1. [잡내 제거] 끓는 물에 닭을 3분간 데쳐 불순물을 씻어냅니다.',
      '2. [색감 비법] 냄비에 닭, 물, 간장, 그리고 "흑설탕"과 커피가루 약간을 넣고 끓입니다. 먹음직스러운 진한 갈색을 내는 비법입니다.',
      '3. [익히기] 감자, 당근, 건고추(매콤함)를 넣고 센불에서 15분간 끓입니다.',
      '4. [졸이기] 국물이 반으로 줄면 양파, 대파, 다진마늘을 넣고 중불에서 국물이 자작해질 때까지 졸입니다.',
      '5. [당면 마무리] 불린 당면을 넣고 3분간 더 끓여 당면이 양념을 머금게 합니다.'
    ]
  },
  {
    id: 20, category: 'Korean', name: '콩국수',
    ingredients: ['소면', '콩', '오이', '토마토', '소금', '설탕'],
    measure: '소면, 콩국물(시판 또는 직접 간 것), 오이, 방울토마토, 검은깨, 소금, 설탕',
    steps: [
      '1. [면 삶기 팁] 끓는 물에 소면을 넣고 물이 끓어오를 때마다 찬물을 반 컵씩 부어주면(3번 반복) 면발이 훨씬 쫄깃해집니다.',
      '2. [차갑게 헹구기] 삶은 면을 얼음물에 헹궈 열기를 완전히 식히고 물기를 뺍니다.',
      '3. [담기] 그릇에 면을 담고 차갑게 보관한 콩국물을 넉넉히 붓습니다.',
      '4. [고명] 채 썬 오이와 방울토마토, 검은깨를 올려 색감을 살립니다.',
      '5. [간 맞추기] 전라도는 설탕, 그 외 지역은 소금! 취향에 맞게 간을 해서 드세요.'
    ]
  },
  // --- JAPANESE (21-30) ---
  {
    id: 21, category: 'Japanese', name: '초밥',
    ingredients: ['밥', '식초', '설탕', '소금', '회', '와사비', '간장', '레몬'],
    measure: '갓 지은 밥 2공기(수분 적게), 횟감(연어/광어) 200g, 생와사비, 간장, [단촛물] 식초 3T, 설탕 2T, 소금 0.5t, 레몬즙 약간',
    steps: [
      '1. [샤리(밥) 만들기] 식초, 설탕, 소금을 섞어 전자레인지에 30초 돌려 녹인 뒤, 뜨거운 밥에 붓습니다. 이때 주걱을 세워 자르듯이 섞고 부채질로 "빠르게" 식혀야 밥알에 윤기가 돕니다.',
      '2. [네타(회) 준비] 횟감은 차갑게 유지하고, 키친타월로 표면 수분을 닦아내야 비린내가 나지 않고 식감이 쫀득해집니다.',
      '3. [손물 준비] 손에 밥알이 달라붙지 않게 물과 식초를 1:1로 섞은 손물을 준비해 손끝에 살짝만 묻힙니다.',
      '4. [쥐기 기술] 오른손으로 밥을 15g(탁구공 절반) 정도 쥐어 둥글리고, 왼손에 회를 올린 뒤 와사비를 콩알만큼 바릅니다. 밥을 올리고 엄지로 살짝 눌러 공기층을 만들어주세요.',
      '5. [완성] 접시에 담고 붓으로 간장을 살짝 발라 내거나, 초생강과 락교를 곁들입니다.'
    ]
  },
  {
    id: 22, category: 'Japanese', name: '라멘',
    ingredients: ['라면', '육수', '숙주', '대파', '계란', '돼지고기', '김', '다진마늘', '식용유'],
    measure: '라멘 생면 1개, 시판 돈코츠 육수 400ml, 숙주 한 줌, 대파(흰부분), 반숙 계란(아지타마고), 차슈(또는 대패삼겹), 김 2장, 다진마늘, 식용유',
    steps: [
      '1. [그릇 예열] 라멘은 온도가 생명입니다. 완성된 라멘을 담을 그릇에 뜨거운 물을 부어 미리 데워두세요.',
      '2. [육수 팁] 시판 육수를 끓일 때 다진 마늘 0.5T와 돼지비계(또는 식용유)를 살짝 넣어 같이 끓이면 인스턴트 맛이 사라지고 깊은 풍미가 납니다.',
      '3. [면 삶기] 끓는 물에 면을 넣고 포장지 시간보다 30초 덜 삶아(카타멘), 먹는 동안 퍼지는 것을 방지합니다.',
      '4. [숙주 데치기] 면을 건지기 직전(10초 전)에 숙주를 망에 넣어 육수가 아닌 면수에서 살짝만 데쳐 아삭함을 살립니다.',
      '5. [담기] 예열한 그릇의 물을 버리고 면과 숙주를 담은 뒤 육수를 붓습니다.',
      '6. [토핑] 구운 차슈, 반숙 계란, 채 썬 파, 김을 올리고 후추나 깨를 갈아 넣습니다.'
    ]
  },
  {
    id: 23, category: 'Japanese', name: '우동',
    ingredients: ['우동면', '간장', '어묵', '대파', '튀김가루', '쑥갓', '맛술', '다시다'],
    measure: '냉동 우동면 1개, 쯔유(간장 소스), 물 400ml, 사각어묵 1장, 대파, 쑥갓, 텐카스(튀김부스러기), 맛술 1T, 가쓰오부시 다시다 약간',
    steps: [
      '1. [육수 비율] 물과 쯔유의 비율을 7:1(제품별 상이)로 맞추고, 맛술 1T를 더해 감칠맛을 올린 뒤 끓입니다. 어묵을 미리 넣어 국물 맛을 우려내세요.',
      '2. [면 삶기 꿀팁] 끓는 물에 냉동 면을 넣고 젓가락으로 억지로 풀지 마세요. 1분간 그대로 두어 면이 자연스럽게 풀려야 쫄깃함이 유지되고 끊어지지 않습니다.',
      '3. [찬물 샤워(선택)] 면이 다 익으면 찬물에 헹궈 전분기를 씻고 다시 뜨거운 육수에 토렴하면 훨씬 탱탱해지지만, 귀찮으면 생략 가능합니다.',
      '4. [담기] 그릇에 면과 국물을 담습니다.',
      '5. [토핑의 미학] 텐카스(튀김부스러기)는 먹기 직전에 뿌려 바삭함을 즐기고, 쑥갓과 대파를 듬뿍 올려 향을 더합니다.'
    ]
  },
  {
    id: 24, category: 'Japanese', name: '규동',
    ingredients: ['소고기', '밥', '양파', '계란', '간장', '설탕', '맛술', '다시다', '대파', '생강'],
    measure: '우삼겹 150g, 밥 1공기, 양파 1/2개, 계란 1개, 대파, 초생강, [소스] 쯔유 4T, 물 4T, 설탕 1.5T, 맛술 2T, 다시다 한 꼬집',
    steps: [
      '1. [소스 조리] 프라이팬에 소스 재료와 채 썬 양파를 넣고 중불에서 끓입니다. 양파가 투명해질 때까지 충분히 익혀 단맛을 뽑아냅니다.',
      '2. [고기 투하] 소스가 끓어오르면 얇은 소고기(우삼겹)를 넣습니다. 고기를 한 장씩 떼어 넣어야 뭉치지 않고 간이 고루 뱁니다.',
      '3. [거품 제거] 고기가 익으면서 나오는 거품(핏물)을 걷어내야 맛이 깔끔해집니다.',
      '4. [계란 팁] 계란은 흰자와 노른자를 대충 섞어(완전히 섞지 않음) 붓고, 뚜껑을 덮어 30초만 익혀 반숙 상태로 만듭니다.',
      '5. [담기] 갓 지은 밥 위에 국물까지 넉넉히 붓고, 초생강과 송송 썬 쪽파를 올립니다. (날계란 노른자만 따로 올려도 좋습니다)'
    ]
  },
  {
    id: 25, category: 'Japanese', name: '오코노미야키',
    ingredients: ['양배추', '베이컨', '계란', '부침가루', '마요네즈', '가쓰오부시', '대파', '식용유', '간장'],
    measure: '양배추 150g(많이), 베이컨 3줄, 계란 1개, 부침가루 1컵, 물 2/3컵, 오코노미야키 소스(또는 돈까스소스+케찹), 마요네즈, 가쓰오부시',
    steps: [
      '1. [공기 반죽] 볼에 부침가루, 물, 계란을 넣고 섞은 뒤, 얇게 채 썬 양배추를 넣고 "젓가락으로 가볍게" 섞습니다. 너무 치대면 전이 딱딱해집니다.',
      '2. [모양 잡기] 달군 팬에 기름을 넉넉히 두르고 반죽을 2cm 두께로 도톰하게 올린 뒤, 절대 누르지 말고 모양만 잡아주세요.',
      '3. [베이컨 토핑] 반죽 위에 베이컨을 틈 없이 덮어줍니다 (돼지기름이 반죽으로 스며들게 함).',
      '4. [인내의 굽기] 뒤집어서 뚜껑을 덮고 약불에서 4~5분간 속까지 푹 익힙니다. 양배추의 수분으로 찌듯이 굽는 것이 포인트입니다.',
      '5. [마무리] 접시에 담고 소스와 마요네즈를 높은 곳에서 얇게 뿌린 뒤, 가쓰오부시를 춤추듯 올려 냅니다.'
    ]
  },
  {
    id: 26, category: 'Japanese', name: '타코야키',
    ingredients: ['밀가루', '문어', '계란', '대파', '튀김가루', '마요네즈', '가쓰오부시', '식용유', '간장'],
    measure: '타코야키 파우더 200g, 물 600ml(묽게), 문어(또는 오징어/새우), 계란 1개, 텐카스, 쪽파, 식용유, 소스, 마요네즈, 가쓰오부시',
    steps: [
      '1. [반죽 농도] 타코야키 반죽은 "생각보다 훨씬 묽게(물처럼)" 만들어야 겉바속촉이 됩니다. 파우더와 물을 잘 섞어 냉장고에 30분 숙성하면 더 좋습니다.',
      '2. [기름 코팅] 팬을 달구고 붓으로 기름을 넉넉히(튀기듯이) 바릅니다.',
      '3. [재료 투하] 반죽을 80% 채우고 문어를 넣은 뒤, 텐카스와 파를 넘칠 정도로 수북하게 뿌립니다. 그 위에 반죽을 다시 넘치도록 붓습니다.',
      '4. [성형 기술] 바닥이 익으면 꼬치로 구획을 나누고 90도씩 돌려가며 안쪽의 익지 않은 반죽을 밖으로 빼내 둥글게 만듭니다.',
      '5. [크리스피] 계속 굴려가며 겉면이 갈색이 될 때까지 충분히 구워야 식어도 쭈그러들지 않습니다.'
    ]
  },
  {
    id: 27, category: 'Japanese', name: '튀김 (덴푸라)',
    ingredients: ['새우', '고구마', '튀김가루', '식용유', '얼음'],
    measure: '새우, 고구마, 깻잎, 튀김가루 1컵, "얼음물" 1컵, 식용유, [소스] 쯔유+물+무즙',
    steps: [
      '1. [손질] 새우는 물총(꼬리 물주머니)을 제거하고 배 쪽에 칼집을 넣어 뚝뚝 끊어주면 튀길 때 구부러지지 않고 일자로 펴집니다.',
      '2. [반죽 비법] 볼에 튀김가루와 "얼음물"을 넣고 젓가락으로 콕콕 찌르듯 대충 섞습니다. 날가루가 보여야 정상이며, 많이 저으면 글루텐이 생겨 눅눅해집니다.',
      '3. [덧가루] 재료에 마른 튀김가루를 아주 얇게 묻힌 뒤 털어내고 반죽물에 담급니다.',
      '4. [눈꽃 튀김] 170도 기름에 재료를 넣고, 손가락으로 반죽물을 기름 위에 흩뿌려 튀김꽃(눈꽃)을 피워 재료에 붙여주면 전문점처럼 바삭해집니다.',
      '5. [기름 빼기] 튀김망에 올려 공기가 통하게 식혀야 바삭함이 오래 유지됩니다.'
    ]
  },
  {
    id: 28, category: 'Japanese', name: '야키소바',
    ingredients: ['중화면', '돼지고기', '양배추', '숙주', '양파', '굴소스', '케찹', '간장', '설탕', '마요네즈', '가쓰오부시'],
    measure: '야키소바면(또는 라면사리), 대패삼겹살 100g, 양배추, 숙주, 양파, 당근, [소스] 간장 1T, 굴소스 1T, 우스터소스 2T, 설탕 1T, 케찹 0.5T',
    steps: [
      '1. [면 준비] 시판 야키소바면은 전자레인지에 30초 돌려 가닥가닥 풀어두면 볶을 때 끊어지지 않습니다.',
      '2. [고기 볶기] 팬에 기름을 두르고 돼지고기와 파를 먼저 볶아 향을 냅니다.',
      '3. [채소 볶기] 고기가 익으면 양파, 당근, 양배추 순으로 넣고 센불에서 볶습니다.',
      '4. [면과 소스] 면과 소스를 넣고 물 2스푼을 가장자리에 둘러 증기로 면을 익히며 소스가 배어들게 볶습니다.',
      '5. [숙주 타이밍] 불을 끄기 30초 전에 숙주를 넣고 재빨리 섞어 아삭한 식감을 살립니다.',
      '6. [토핑] 계란 프라이(반숙)를 올리고 마요네즈, 파슬리, 초생강을 곁들입니다.'
    ]
  },
  {
    id: 29, category: 'Japanese', name: '카레라이스',
    ingredients: ['카레', '돼지고기', '양파', '감자', '당근', '버터', '밥', '케찹', '후추'],
    measure: '고형카레 2조각, 돼지고기(카레용) 100g, 양파 1개(많이), 감자 1개, 당근 1/2개, 버터 10g, 물 500ml, 케찹 1T',
    steps: [
      '1. [양파 볶기] 냄비에 버터와 식용유를 두르고 얇게 썬 양파를 약불에서 20분 이상 갈색이 될 때까지 볶습니다(카라멜라이징). 이것이 맛의 깊이를 결정합니다.',
      '2. [재료 볶기] 고기, 감자, 당근을 넣고 고기 겉면이 익을 때까지 볶아 코팅합니다.',
      '3. [끓이기] 물을 붓고 재료가 푹 익을 때까지 15분간 끓이다가, 불을 끄고 고형 카레를 넣어 녹입니다.',
      '4. [비법 재료] 다시 불을 켜고 약불에서 저어가며 끓이다가 "케찹 1스푼"이나 다크 초콜릿 한 조각을 넣으면 풍미가 폭발합니다.',
      '5. [숙성] 바로 먹어도 맛있지만, 식혀서 하루 뒤에 먹으면 맛이 어우러져 훨씬 맛있어집니다.'
    ]
  },
  {
    id: 30, category: 'Japanese', name: '소바',
    ingredients: ['소면', '간장', '무', '대파', '와사비', '김', '맛술', '설탕'],
    measure: '메밀면 1인분, 쯔유, 물, 무 1토막, 쪽파, 생와사비, 김가루, 얼음',
    steps: [
      '1. [면 삶기] 끓는 물에 메밀면을 넣고 4~5분간 삶습니다. 끓어넘치려 하면 찬물을 부어주세요.',
      '2. [전분 제거] 삶은 면을 찬물(얼음물)에 담가 빨래하듯이 "빡빡" 문질러 씻어야 겉면의 전분기가 사라지고 식감이 매끄러워집니다.',
      '3. [플레이팅] 물기를 완벽하게 털어내고 채반(자루)에 담은 뒤 김가루를 중앙에 올립니다.',
      '4. [소스 비율] 시판 쯔유와 찬물을 1:3 비율(제품에 따라 조절)로 섞고 얼음을 띄웁니다.',
      '5. [야쿠미(고명)] 무는 강판에 갈아 물기를 살짝 짜서 둥글게 뭉치고, 쪽파와 와사비를 곁들입니다.',
      '6. [먹는 법] 소스에 고명을 풀고 면을 끝부분만 살짝 찍어 후루룩 소리 내어 먹습니다.'
    ]
  },
  // --- CHINESE (31-40) ---
  {
    id: 31, category: 'Chinese', name: '짜장면',
    ingredients: ['중화면', '춘장', '돼지고기', '양파', '대파', '양배추', '설탕', '굴소스', '전분', '식용유', '간장', '생강'],
    measure: '중화면 1인분, 춘장 2T, 돼지고기(다짐육/등심) 100g, 양파 1개, 대파 1대, 양배추 한 줌, 설탕 1.5T, 굴소스 1T, 진간장 1T, 식용유 4T, 전분물(전분1:물1)',
    steps: [
      '1. [춘장 튀기기 - 핵심] 팬에 식용유 3T를 두르고 춘장을 넣어 약불에서 3~5분간 튀기듯 볶습니다. 춘장의 떫은맛이 사라지고 고소한 맛이 살아납니다. (기름과 춘장은 따로 덜어둠)',
      '2. [파기름과 고기] 춘장 볶은 기름을 다시 팬에 두르고 대파와 고기, 다진 생강 약간을 넣어 노릇해질 때까지 센불에 볶습니다.',
      '3. [간장 불맛] 고기 기름이 나오면 진간장 1T를 팬 가장자리에 둘러 "치익" 소리가 나게 태워 불맛을 입힙니다.',
      '4. [채소 볶기] 양파와 양배추를 넣고 센불에서 볶다가, 볶아둔 춘장과 설탕, 굴소스를 넣고 잘 섞이도록 볶습니다.',
      '5. [끓이기] 물 1컵을 붓고 끓어오르면 전분물을 조금씩 넣어 농도를 걸쭉하게 맞춥니다(짜장 소스 완성).',
      '6. [면 삶기] 끓는 물에 중화면을 삶아 찬물에 헹군 뒤 따뜻한 물에 토렴(살짝 데침)하여 그릇에 담고 소스를 붓습니다.'
    ]
  },
  {
    id: 32, category: 'Chinese', name: '짬뽕',
    ingredients: ['중화면', '오징어', '새우', '홍합', '돼지고기', '양파', '배추', '대파', '다진마늘', '고춧가루', '간장', '굴소스', '치킨스톡'],
    measure: '중화면 1인분, 해물믹스 150g, 돼지고기 50g, 양파 1/2개, 배추 2장, 대파, 다진마늘 1T, 고춧가루 3T, 간장 1T, 굴소스 1T, 치킨스톡(또는 사골육수) 500ml',
    steps: [
      '1. [고추기름 베이스] 웍에 식용유를 넉넉히 두르고 대파, 다진 마늘, 돼지고기를 볶다가 불을 줄이고 고춧가루 3T를 넣어 타지 않게 볶아 빨간 고추기름을 냅니다.',
      '2. [불맛 입히기] 불을 가장 세게 올리고 간장 1T를 팬 가장자리에 태우듯 넣은 뒤, 해물과 채소(양파, 배추)를 넣고 빠르게 볶아 불맛을 입힙니다.',
      '3. [육수 끓이기] 뜨거운 육수(또는 물)를 붓고 굴소스, 치킨스톡, 소금으로 간을 한 뒤 5분간 팔팔 끓여 맛을 우려냅니다.',
      '4. [채소 식감] 마지막에 청경채나 숙주를 넣으면 아삭한 식감이 살아납니다.',
      '5. [면 삶기] 면을 삶아 물기를 빼고 그릇에 담은 뒤 뜨거운 국물을 붓습니다.'
    ]
  },
  {
    id: 33, category: 'Chinese', name: '탕수육',
    ingredients: ['돼지고기', '전분', '식용유', '계란', '설탕', '식초', '간장', '당근', '오이', '목이버섯'],
    measure: '돼지 등심 300g, 감자전분 1컵, 계란 흰자 1개, 식용유, [소스] 물 1컵, 설탕 6T, 식초 4T, 간장 2T, 채소 약간, 전분물',
    steps: [
      '1. [전분 불리기 - 비법] 감자전분에 물을 부어 30분 이상 둔 뒤, 윗물은 따라 버리고 가라앉은 꾸덕한 "앙금"만 사용해야 튀김옷이 쫀득하고 바삭합니다.',
      '2. [반죽하기] 앙금에 식용유 2T와 계란 흰자를 섞어 마요네즈 질감의 반죽을 만들고 밑간한 고기를 버무립니다.',
      '3. [1차 튀김] 170도 기름에 고기를 하나씩 넣고 3분간 튀겨 속까지 익힌 뒤 건져내어 수분을 날립니다.',
      '4. [2차 튀김 (크리스피)] 기름 온도를 180도로 높여 1분간 한 번 더 튀기면 겉면의 수분이 날아가 "바삭" 소리가 나는 탕수육이 됩니다.',
      '5. [소스 만들기] 냄비에 소스 재료와 채소를 넣고 끓이다가 전분물을 조금씩 넣어 걸쭉하게 농도를 맞춥니다.'
    ]
  },
  {
    id: 34, category: 'Chinese', name: '마파두부',
    ingredients: ['두부', '다짐육', '대파', '마늘', '두반장', '굴소스', '고춧가루', '설탕', '전분', '참기름', '산초가루'],
    measure: '두부 1모, 다진 돼지고기 100g, 대파 1/2대, 다진마늘 1T, 두반장 2T, 굴소스 1T, 고춧가루 1T, 설탕 1t, 전분물, 산초가루(화자오)',
    steps: [
      '1. [두부 데치기] 깍둑 썬 두부를 소금 넣은 끓는 물에 1분간 데쳐주세요. 두부가 단단해져 볶을 때 부서지지 않고 간수가 빠져 맛이 깔끔해집니다.',
      '2. [향신유] 팬에 고추기름(또는 식용유)을 두르고 대파와 마늘을 볶아 향을 냅니다.',
      '3. [고기 볶기] 다진 고기를 넣고 뭉치지 않게 풀어가며 바짝 익힌 뒤, 고춧가루와 두반장을 넣고 기름에 볶아 고추기름 색을 냅니다.',
      '4. [끓이기] 물 1컵을 붓고 굴소스, 설탕을 넣은 뒤 데친 두부를 넣고 중불에서 3분간 졸입니다.',
      '5. [농도 조절] 전분물을 조금씩 넣어 걸쭉하게 만들고, 마지막에 참기름과 산초가루를 뿌려 마라 향을 더합니다.'
    ]
  },
  {
    id: 35, category: 'Chinese', name: '볶음밥',
    ingredients: ['밥', '계란', '대파', '당근', '햄', '간장', '굴소스', '식용유', '맛소금', '후추'],
    measure: '식은 밥 1공기, 계란 2개, 대파 1대(흰부분 위주), 당근/햄 약간, 진간장 1T, 굴소스 0.5T, 식용유 4T, 맛소금, 후추',
    steps: [
      '1. [밥 준비] 볶음밥용 밥은 뜨거운 밥보다 식은 밥(또는 즉석밥을 데우지 않고)을 사용해야 밥알이 떡지지 않고 고슬고슬합니다.',
      '2. [파기름] 팬에 식용유를 넉넉히 두르고 송송 썬 대파를 넣어 노릇해질 때까지 볶아 파기름을 냅니다.',
      '3. [스크램블] 파를 한쪽으로 밀고 빈 공간에 계란을 깨 넣어 스크램블을 만든 뒤 파와 섞습니다.',
      '4. [밥 볶기] 밥을 넣고 국자를 세워 밥알을 자르듯이 섞으며 "센불"에서 볶습니다.',
      '5. [눌러주기] 밥을 한쪽으로 밀고 간장 1T를 빈 공간에 넣어 바글바글 끓여 태운 뒤 밥과 섞어 불맛을 냅니다.',
      '6. [간 맞추기] 굴소스로 감칠맛을 더하고 소금, 후추로 간을 한 뒤 수분을 날리며 바짝 볶아 완성합니다.'
    ]
  },
  {
    id: 36, category: 'Chinese', name: '딤섬(만두)',
    ingredients: ['만두피', '돼지고기', '부추', '대파', '생강', '간장', '굴소스', '참기름', '후추', '전분'],
    measure: '만두피 20장, 다진 돼지고기 200g, 부추 100g, 대파, 다진생강 0.5t, 간장 1T, 굴소스 1T, 참기름 1T, 설탕 0.5T, 전분가루 1T',
    steps: [
      '1. [소 반죽 - 핵심] 볼에 다진 고기와 양념, 생강, 전분가루를 넣고 한 방향으로 계속 저어줍니다. 고기에 끈기(실 같은 조직)가 생길 때까지 치대야 육즙이 밖으로 새지 않습니다.',
      '2. [채소 혼합] 끈기가 생긴 고기에 잘게 썬 부추와 대파를 넣고 살살 버무립니다 (채소를 넣고 너무 치대면 풋내가 남).',
      '3. [빚기] 만두피 가장자리에 물을 바르고 소를 넣은 뒤 주름을 잡아 빚습니다.',
      '4. [찌기] 김이 오른 찜기에 10분간 찌거나, 팬에 굽습니다.',
      '5. [빙화만두 팁] 팬에 만두를 굽다가 전분물을 붓고 뚜껑을 덮어 수분이 날아갈 때까지 익히면 바닥은 바삭하고 위는 촉촉한 군만두가 됩니다.'
    ]
  },
  {
    id: 37, category: 'Chinese', name: '양꼬치',
    ingredients: ['양고기', '쯔란', '고춧가루', '참깨', '소금', '식용유'],
    measure: '양고기(어깨살/삼겹) 300g, [시즈닝] 쯔란(큐민홀) 1T, 고춧가루 1T, 참깨 1T, 소금 0.5t, 후추, 식용유',
    steps: [
      '1. [고기 손질] 양고기는 지방과 살코기가 적절히 섞이도록 2cm 큐브 모양으로 썹니다 (지방이 있어야 구울 때 고소함).',
      '2. [마리네이드] 썰어둔 고기에 식용유를 살짝 바르고 시즈닝 가루를 절반만 넣어 버무려 30분간 냉장 숙성합니다.',
      '3. [꼬치 꿰기] 꼬치에 고기를 꽂을 때 너무 빽빽하지 않게 간격을 두어야 사이사이 잘 익습니다.',
      '4. [굽기] 에어프라이어 200도에서 10분(5분 뒤 뒤집기) 굽거나, 프라이팬 중불에서 굴려가며 겉면이 바삭해질 때까지 굽습니다.',
      '5. [완성] 다 익은 꼬치에 남은 쯔란 시즈닝을 듬뿍 찍어 먹습니다.'
    ]
  },
  {
    id: 38, category: 'Chinese', name: '마라탕',
    ingredients: ['마라소스', '사골육수', '소고기', '청경채', '숙주', '버섯', '푸주', '당면', '땅콩버터'],
    measure: '시판 마라소스 1봉, 사골육수 500ml, 샤브용 소고기 100g, 청경채, 각종 버섯, 푸주, 중국당면, 숙주, 즈마장(또는 땅콩버터) 1T',
    steps: [
      '1. [불리기] 푸주(건두부)와 중국당면은 요리 2시간 전부터 찬물에 불려두어야 딱딱하지 않습니다.',
      '2. [소스 볶기] 냄비에 식용유를 살짝 두르고 마라소스를 먼저 볶아 매운 향을 확 올립니다.',
      '3. [육수 만들기] 사골육수와 물을 붓고 끓입니다. 이때 땅콩버터(즈마장) 1T를 풀면 국물이 훨씬 고소하고 매운맛이 부드러워집니다 (전문점 비법).',
      '4. [재료 투하] 육수가 끓으면 익는 데 오래 걸리는 감자, 연근, 완자, 두부류를 먼저 넣습니다.',
      '5. [마무리] 마지막에 소고기, 청경채, 숙주, 당면을 넣고 2~3분간 끓여 완성합니다.'
    ]
  },
  {
    id: 39, category: 'Chinese', name: '토마토 달걀 볶음',
    ingredients: ['토마토', '계란', '대파', '식용유', '굴소스', '소금', '설탕', '참기름'],
    measure: '완숙 토마토 2개, 계란 3개, 대파 1대, 식용유, 소금 한 꼬집, 설탕 1T, 굴소스 0.5T, 참기름',
    steps: [
      '1. [재료 준비] 토마토는 웨지 모양으로 썰고, 계란은 소금을 넣어 풀어둡니다.',
      '2. [스크램블] 팬에 기름을 넉넉히 두르고 계란물을 부어 젓가락으로 저어가며 80%만 익힌 뒤 접시에 덜어둡니다 (너무 익히면 질겨짐).',
      '3. [토마토 볶기] 팬에 다시 기름을 두르고 대파를 볶다 토마토를 넣습니다. 토마토 껍질이 살짝 벗겨지고 즙이 나와 걸쭉해질 때까지 중불에서 충분히 볶습니다.',
      '4. [합치기] 덜어둔 계란을 넣고 굴소스와 설탕으로 간을 맞춥니다. 설탕이 토마토의 신맛을 잡아줍니다.',
      '5. [마무리] 센불에서 빠르게 섞어 불맛을 입히고 불을 끈 뒤 참기름을 살짝 두릅니다.'
    ]
  },
  {
    id: 40, category: 'Chinese', name: '쿵파오 치킨',
    ingredients: ['닭고기', '땅콩', '건고추', '대파', '마늘', '생강', '간장', '식초', '설탕', '굴소스', '전분'],
    measure: '닭가슴살/다리살 300g, 볶은 땅콩 3T, 건고추(페페론치노) 5개, 대파, 마늘, 생강, [소스] 간장 2T, 식초 2T, 설탕 2T, 굴소스 1T, 맛술 1T',
    steps: [
      '1. [닭 밑간] 한입 크기로 썬 닭고기에 간장, 맛술, 전분가루를 넣어 버무립니다. 전분이 육즙을 가두고 식감을 부드럽게 합니다.',
      '2. [닭 익히기] 팬에 기름을 넉넉히 두르고 닭고기를 튀기듯이 볶아 겉면을 노릇하게 익힌 뒤 따로 덜어냅니다.',
      '3. [향신료] 팬에 식용유를 두르고 건고추, 대파, 편마늘, 생강을 약불에서 볶아 매콤한 향을 기름에 입힙니다.',
      '4. [소스 졸이기] 미리 섞어둔 소스를 붓고 바글바글 끓어오르면 닭고기를 넣습니다.',
      '5. [센불 볶기] 소스가 고기에 윤기 나게 코팅되도록 센불에서 빠르게 볶고, 마지막에 땅콩을 넣어 섞습니다.'
    ]
  },
  // --- ITALIAN (41-50) ---
  {
    id: 41, category: 'Italian', name: '알리오 올리오',
    ingredients: ['파스타면', '마늘', '올리브오일', '페페론치노', '소금', '후추', '파슬리'],
    measure: '스파게티면 100g, 통마늘 8개, 엑스트라버진 올리브오일 50ml, 페페론치노 3개, 소금, 후추, 파슬리, 면수',
    steps: [
      '1. [소금물 비율] 물 1L에 소금 10g(1T)을 넣어 "바닷물 농도"를 맞춥니다. 면에 간이 배어야 나중에 싱겁지 않습니다. 면은 포장지 시간보다 2분 덜 삶으세요.',
      '2. [마늘 향 추출] 팬에 오일과 으깬 마늘(또는 편마늘)을 넣고 불을 켜지 않은 상태에서 시작해 "약불"로 천천히 가열합니다. 마늘이 타지 않고 노릇한 금색이 될 때까지 향을 충분히 뽑아냅니다.',
      '3. [에멀전의 기적] 마늘이 노릇해지면 면수 2국자를 팬에 붓습니다. 기름과 물이 만나 자글자글 끓으며 소스가 뽀얗게 변하는 유화(Emulsion) 과정이 핵심입니다.',
      '4. [면 볶기] 덜 익힌 면을 팬에 옮겨 담고 센불에서 볶습니다. 면이 소스를 빨아들이며 퉁퉁 불고 전분이 나와 국물이 걸쭉해질 때까지 맹렬하게 팬을 흔듭니다.',
      '5. [마무리] 불을 끄고 올리브오일을 한 바퀴 더 두른 뒤 파슬리를 뿌려 향긋하게 완성합니다.'
    ]
  },
  {
    id: 42, category: 'Italian', name: '까르보나라',
    ingredients: ['파스타면', '베이컨', '계란', '치즈', '후추', '올리브오일'],
    measure: '스파게티면 100g, 베이컨(또는 관찰레/판체타) 40g, 계란 노른자 2개, 파마산/페코리노 치즈 30g, 통후추, 올리브오일',
    steps: [
      '1. [꾸덕한 소스] 볼에 계란 노른자와 갈아둔 치즈, 후추를 넉넉히 넣고 섞어 되직한 반죽처럼 만들어 둡니다(생크림을 넣지 않는 것이 정통 방식).',
      '2. [기름 뽑기] 팬에 오일을 살짝 두르고 베이컨을 약불에서 천천히 볶아 바삭하게 만들고 기름(지방)을 충분히 뽑아냅니다.',
      '3. [면 코팅] 삶은 면을 베이컨 팬에 넣고 베이컨 기름으로 면을 코팅하듯 볶은 뒤, 면수 반 국자를 넣어 온도를 살짝 낮춥니다.',
      '4. [온도 조절] **불을 끕니다.** 팬을 화구에서 내려 10초간 식힙니다. 너무 뜨거우면 계란국(스크램블)이 되어버립니다.',
      '5. [만테까레] 준비한 계란 치즈 소스를 붓고 잔열로 빠르게 비벼줍니다. 소스가 크림처럼 부드럽게 면에 감기면 성공입니다.',
      '6. [서빙] 접시에 담고 후추를 한 번 더 듬뿍 갈아 올립니다.'
    ]
  },
  {
    id: 43, category: 'Italian', name: '토마토 파스타',
    ingredients: ['파스타면', '토마토소스', '마늘', '양파', '올리브오일', '바질', '버터', '페페론치노'],
    measure: '스파게티면 100g, 시판 토마토소스 1.5컵, 마늘 3알, 양파 1/4개, 페페론치노 1개, 올리브오일, 바질, 버터 10g',
    steps: [
      '1. [향 채소] 팬에 올리브오일을 두르고 다진 마늘과 양파를 투명해질 때까지 충분히 볶아 단맛과 향을 냅니다.',
      '2. [소스 끓이기] 토마토소스를 붓고 면수 1국자를 넣어 3분 이상 끓입니다. 시판 소스의 텁텁한 신맛을 날리고 풍미를 올리는 과정입니다.',
      '3. [면과 소스의 조화] 삶은 면을 소스에 넣고 1~2분간 함께 볶아 면 속까지 간이 배게 합니다.',
      '4. [쉐프의 킥] 불을 끄기 직전에 차가운 버터 한 조각을 넣어 섞어주세요. 소스의 산미가 부드러워지고 고급스러운 풍미가 생깁니다.',
      '5. [마무리] 접시에 담고 손으로 찢은 생바질을 올려 향을 더합니다.'
    ]
  },
  {
    id: 44, category: 'Italian', name: '피자 마르게리타',
    ingredients: ['또띠아', '토마토소스', '모짜렐라치즈', '바질', '올리브오일'],
    measure: '또띠아(또는 피자도우), 토마토소스 3T, 생모짜렐라치즈 100g, 생바질, 엑스트라버진 올리브오일',
    steps: [
      '1. [도우 준비] 또띠아 두 장을 겹쳐 쓰거나 도우를 준비합니다. 토마토소스는 너무 많이 바르면 도우가 축축해지니 얇게 펴 바릅니다.',
      '2. [치즈 배치] 생모짜렐라 치즈는 물기를 제거하고 손으로 듬성듬성 찢어 올립니다. 여백의 미가 있어야 치즈가 녹았을 때 예쁩니다.',
      '3. [고온 조리] 오븐이나 에어프라이어 온도를 최대로(200~230도) 예열합니다. 피자는 단시간에 높은 열로 구워야 도우가 바삭합니다.',
      '4. [오일 터치] 굽기 전에 올리브오일을 한 바퀴 둘러주면 풍미가 살고 치즈가 마르는 것을 막아줍니다.',
      '5. [바질 타이밍] 피자가 다 구워져 나오면 그때 신선한 바질을 올립니다(같이 구우면 바질이 타서 검게 변함).'
    ]
  },
  {
    id: 45, category: 'Italian', name: '리조또',
    ingredients: ['쌀', '육수', '양파', '버터', '치즈', '화이트와인', '식용유'],
    measure: '불리지 않은 쌀 100g, 치킨스톡 육수 600ml, 양파 1/4개, 버터 20g, 파마산치즈 2T, 화이트와인 30ml, 식용유',
    steps: [
      '1. [쌀 볶기(Tostatura)] 쌀은 씻지 않고 사용합니다. 팬에 오일과 다진 양파를 볶다가 쌀을 넣고 쌀알이 뜨거워질 때까지 볶아 전분막을 코팅합니다.',
      '2. [잡내 제거] 화이트와인을 붓고 치이익 소리와 함께 알코올과 쌀의 잡내를 날려보냅니다.',
      '3. [육수 주입] 뜨거운 육수를 한 국자씩 넣습니다. 한 번에 다 붓지 않고, 쌀이 육수를 흡수하면 다시 붓기를 반복하며 계속 저어줍니다(마찰로 전분 용출).',
      '4. [알덴테] 약 15~18분 후 쌀알 심지가 살짝 씹히는 정도가 되면 불을 끕니다. 국물이 살짝 흐를 정도의 농도여야 합니다.',
      '5. [만테까레(Mantecatura)] 불을 끈 상태에서 차가운 버터와 치즈를 넣고 팬을 힘차게 흔들며 섞습니다. 공기가 주입되어 크림처럼 부드러운 질감이 됩니다.'
    ]
  },
  {
    id: 46, category: 'Italian', name: '라자냐',
    ingredients: ['파스타면', '토마토소스', '크림소스', '모짜렐라치즈', '치즈'],
    measure: '라자냐 면, 라구소스(미트소스) 200g, 베샤멜소스(크림소스) 100g, 모짜렐라치즈 100g, 파마산치즈',
    steps: [
      '1. [소스 준비] 시판 소스를 사용하더라도 라구 소스에 다진 고기를 더 볶아 넣으면 풍미가 훨씬 좋아집니다.',
      '2. [레이어링] 오븐 용기에 소스 -> 면 -> 라구소스 -> 베샤멜소스 -> 치즈 순서로 꼼꼼히 쌓습니다. 빈틈없이 채워야 자를 때 무너지지 않습니다.',
      '3. [수분 가두기] 용기 윗면을 쿠킹호일로 덮고 180도 오븐에서 20분간 구워 속을 익힙니다.',
      '4. [색 내기] 호일을 벗기고 200도로 올려 10분간 더 구워 치즈가 지글지글 끓고 갈색이 되게 합니다.',
      '5. [레스팅 필수] 오븐에서 꺼내자마자 자르면 소스가 다 흘러내립니다. 실온에서 15분 이상 식혀 층이 단단해진 뒤 썰어냅니다.'
    ]
  },
  {
    id: 47, category: 'Italian', name: '뇨끼',
    ingredients: ['감자', '밀가루', '계란', '크림소스', '치즈', '소금', '버터'],
    measure: '감자 2개, 밀가루(중력분) 100g, 계란 노른자 1개, 소금, 파마산치즈, 크림소스, 버터',
    steps: [
      '1. [수분 제거] 감자는 물에 삶기보다 오븐이나 에어프라이어에 굽거나 쪄서 수분을 최소화해야 반죽이 질척이지 않습니다.',
      '2. [반죽 팁] 으깬 감자가 식으면 밀가루, 노른자를 넣고 "가볍게" 뭉칩니다. 수제비 반죽처럼 많이 치대면 글루텐이 생겨 식감이 고무처럼 질겨집니다.',
      '3. [삶기] 끓는 물에 뇨끼를 넣고 물 위로 둥둥 떠오르면 다 익은 것입니다. 건져냅니다.',
      '4. [팬 프라잉] (셰프의 팁) 삶은 뇨끼를 바로 소스에 넣지 않고, 버터를 두른 팬에 앞뒤로 노릇하게 한 번 구우면 "겉바속촉" 식감이 됩니다.',
      '5. [버무리기] 따뜻한 크림소스에 구운 뇨끼를 넣고 가볍게 버무려 냅니다.'
    ]
  },
  {
    id: 48, category: 'Italian', name: '카프레제 샐러드',
    ingredients: ['토마토', '모짜렐라치즈', '바질', '올리브오일', '소금', '후추', '발사믹글레이즈'],
    measure: '완숙 토마토, 생모짜렐라치즈, 생바질, 엑스트라버진 올리브오일, 소금, 통후추, 발사믹글레이즈',
    steps: [
      '1. [온도] 토마토와 치즈는 냉장고에서 꺼내 찬기를 살짝 뺀 상태(실온 20도)에서 먹어야 향과 맛이 가장 잘 느껴집니다.',
      '2. [물기 제거] 치즈와 토마토의 표면 물기를 키친타월로 살짝 닦아내야 오일 소스가 겉돌지 않습니다.',
      '3. [플레이팅] 토마토, 치즈, 바질 잎을 번갈아 가며 겹쳐 담습니다.',
      '4. [밑간] 재료 위에 소금과 통후추를 갈아 뿌려 재료 본연의 단맛과 감칠맛을 끌어올립니다(매우 중요).',
      '5. [오일 샤워] 가장 좋은 품질의 올리브오일을 아끼지 말고 듬뿍 뿌립니다. 발사믹 글레이즈는 취향껏 곁들입니다.'
    ]
  },
  {
    id: 49, category: 'Italian', name: '티라미수',
    ingredients: ['치즈', '생크림', '설탕', '커피', '쿠키', '코코아파우더'],
    measure: '마스카포네치즈 200g, 생크림 150ml, 설탕 40g, 진한 에스프레소, 레이디핑거 쿠키, 코코아파우더',
    steps: [
      '1. [크림 비율] 마스카포네 치즈는 실온에 두어 부드럽게 풀고, 생크림은 설탕을 넣어 단단하게 뿔이 설 정도로 휘핑한 뒤 두 가지를 살살 섞습니다.',
      '2. [커피 디핑] 식혀둔 에스프레소에 쿠키를 담글 때는 "1초만" 빠르게 담갔다 뺍니다. 오래 담그면 나중에 축축해서 물이 나옵니다.',
      '3. [층 쌓기] 용기에 쿠키 -> 크림 -> 쿠키 -> 크림 순으로 평평하게 채웁니다.',
      '4. [숙성] 냉장고에서 최소 4시간, 가장 좋게는 하루 정도 숙성시키면 크림과 쿠키가 맛이 어우러지고 질감이 안정됩니다.',
      '5. [더스팅] 먹기 직전에 코코아 파우더를 빈틈없이 뿌립니다. 미리 뿌려두면 가루가 젖어 예쁘지 않습니다.'
    ]
  },
  {
    id: 50, category: 'Italian', name: '스테이크',
    ingredients: ['소고기', '올리브오일', '버터', '마늘', '소금', '후추', '로즈마리'],
    measure: '스테이크용 소고기(안심/등심) 3cm 두께, 올리브오일, 무염버터 30g, 통마늘, 로즈마리, 소금, 후추',
    steps: [
      '1. [상온 복귀] 고기는 굽기 30분~1시간 전에 꺼내 차가운 기운을 없앱니다. 속이 차가우면 겉은 타고 속은 안 익습니다.',
      '2. [드라이 & 시즈닝] 키친타월로 표면 수분을 완벽하게 제거하고(수분이 있으면 튀겨지지 않고 삶아짐), 소금과 후추, 오일을 듬뿍 바릅니다.',
      '3. [시어링] 팬에서 연기가 날 때 고기를 올립니다. 센불에서 겉면이 짙은 갈색 크러스트가 생길 때까지(마이야르) 1분씩 뒤집으며 굽습니다.',
      '4. [아로제(Basting)] 불을 줄이고 버터, 으깬 마늘, 허브를 넣습니다. 팬을 기울여 녹은 버터를 숟가락으로 퍼서 고기에 계속 끼얹어 향을 입힙니다.',
      '5. [레스팅] 다 구운 고기를 바로 썰면 육즙이 콸콸 쏟아져 나옵니다. 도마 위에서 5분간 쉬게 두어 육즙을 가두세요.'
    ]
  },
  // --- OTHER (51-60) ---
  {
    id: 51, category: 'Other', name: '햄버거',
    ingredients: ['식빵', '다짐육', '치즈', '토마토', '양상추', '양파', '마요네즈', '소금', '후추', '버터', '식용유'],
    measure: '햄버거번(또는 식빵) 2개, 소고기 다짐육 200g, 체다치즈 2장, 토마토 슬라이스, 양상추, 양파, 마요네즈, 소금, 후추, 버터, 식용유',
    steps: [
      '1. [패티 성형 꿀팁] 다진 소고기에 소금, 후추를 넉넉히 뿌리고 찰기가 생길 때까지 치댄 후, 구울 때 가운데가 부풀어 오르지 않도록 엄지로 가운데를 꾹 눌러 오목하게 빚습니다.',
      '2. [번 굽기] 팬에 버터를 두르고 빵의 안쪽 면을 노릇한 갈색이 될 때까지 구워 바삭하게 만듭니다(소스가 스며들어 눅눅해지는 것을 방지).',
      '3. [패티 굽기] 팬에서 연기가 살짝 날 정도로 달군 뒤 기름을 두르고 패티를 올립니다. 센불에서 한 면당 2~3분씩 구워 진한 갈색(마이야르)을 냅니다.',
      '4. [치즈 멜팅] 패티를 뒤집고 치즈를 올린 뒤, 팬 뚜껑을 덮고 불을 끄세요. 1분간 잔열로 치즈를 완벽하게 녹입니다.',
      '5. [조립] 빵 안쪽에 마요네즈를 꼼꼼히 바르고 양상추 -> 토마토 -> 양파 -> 패티 순으로 쌓아 육즙이 채소를 타고 흐르도록 합니다.'
    ]
  },
  {
    id: 52, category: 'Other', name: '감바스 알 아히요',
    ingredients: ['새우', '마늘', '올리브오일', '바게트', '소금', '후추', '페페론치노', '파슬리'],
    measure: '새우 10마리, 통마늘 10알, 올리브오일 150ml, 페페론치노 5개, 바게트, 소금, 후추, 파슬리',
    steps: [
      '1. [재료 손질] 새우는 물기를 완벽히 제거해야 기름이 튀지 않습니다. 마늘은 너무 얇지 않게 도톰하게 편 썰어야 타지 않고 쫀득해집니다.',
      '2. [마늘 향 내기] 차가운 팬에 오일과 마늘을 넣고 "약불"에서 천천히 끓입니다. 마늘이 타지 않고 노릇한 연한 갈색이 될 때까지 5분 이상 충분히 우려내세요.',
      '3. [매운맛 추가] 마늘 향이 고소하게 올라오면 페페론치노를 손으로 비벼 부숴 넣습니다.',
      '4. [새우 익히기] 불을 중불로 올리고 새우를 넣습니다. 새우가 붉은색으로 변하고 몸이 C자로 말리면 바로 불을 끕니다(너무 오래 익히면 질겨짐).',
      '5. [에멀전] 불을 끄고 파슬리를 뿌린 뒤 팬을 흔들어 오일과 재료가 잘 섞이게 합니다.',
      '6. [서빙] 오일이 식기 전에 바게트를 푹 찍어 마늘, 새우와 함께 먹습니다.'
    ]
  },
  {
    id: 53, category: 'Other', name: '쌀국수',
    ingredients: ['쌀국수', '육수', '소고기', '숙주', '양파', '고수', '레몬', '식초', '설탕', '칠리소스', '해선장'],
    measure: '쌀국수면 1인분, 시판 육수 500ml, 샤브용 소고기 100g, 숙주 한 줌, 양파 1/2개, 레몬/라임, 고수, 식초, 설탕',
    steps: [
      '1. [면 불리기] 쌀국수 면은 끓이지 않고 찬물에 최소 30분 이상 불려두어야 식감이 쫄깃하고 뚝뚝 끊어지지 않습니다.',
      '2. [양파 절임] 양파를 최대한 얇게 채 썰어 식초:설탕:물(1:1:1) 비율로 10분간 절여두면 국수의 느끼함을 잡아줍니다.',
      '3. [육수 끓이기] 냄비에 육수를 붓고 팔팔 끓입니다. 이때 숙주 비린내가 싫다면 육수에 살짝 토렴(담갔다 빼기)해주세요.',
      '4. [면과 고기] 끓는 육수에 불린 면을 체에 담아 10초간 살짝 데쳐 그릇에 담고, 얇은 소고기는 육수에 넣어 핏기가 가실 정도로만 익혀 올립니다.',
      '5. [담기] 숙주를 면 아래에 깔고(숨 죽이기), 절인 양파, 고수, 레몬을 올립니다.',
      '6. [소스 팁] 국물 본연의 맛을 즐기다가 중간에 해선장(달콤)과 칠리소스(매콤)를 섞어 드세요.'
    ]
  },
  {
    id: 54, category: 'Other', name: '팟타이',
    ingredients: ['쌀국수', '새우', '숙주', '계란', '다진마늘', '설탕', '굴소스', '식초', '부추', '땅콩', '식용유', '피시소스'],
    measure: '쌀국수면 100g, 새우 5마리, 숙주 100g, 부추, 계란 2개, 다진마늘 1T, 다진땅콩, 식용유, [소스] 피시소스(액젓) 2T, 설탕 2T, 굴소스 1T, 식초 1.5T, 물 2T',
    steps: [
      '1. [면 준비] 쌀국수 면은 절대 삶지 말고 찬물에 1시간 불려 준비합니다. (볶을 때 퍼지지 않음)',
      '2. [스크램블] 팬에 기름을 두르고 계란을 넣어 몽글몽글하게 익힌 뒤 따로 덜어둡니다.',
      '3. [향 내기] 팬에 기름을 넉넉히 두르고 다진 마늘과 새우를 넣어 볶다가, 마늘이 노릇해지면 불린 면과 소스를 전부 넣습니다.',
      '4. [면 볶기] "센불"에서 면이 소스를 빨아들이고 부드러워질 때까지 볶습니다. 너무 뻑뻑하면 물을 1숟가락씩 추가하세요.',
      '5. [골든 타임] 면이 다 익으면 숙주와 부추, 미리 익힌 계란을 넣고 30초만 빠르게 볶아 불을 끕니다(숙주의 아삭함을 살리는 것이 생명).',
      '6. [토핑] 접시에 담고 으깬 땅콩과 고춧가루, 레몬즙을 뿌려 섞어 먹습니다.'
    ]
  },
  {
    id: 55, category: 'Other', name: '치킨 커리',
    ingredients: ['닭고기', '요거트', '양파', '토마토소스', '카레', '버터', '다진마늘', '후추', '소금'],
    measure: '닭다리살 300g, 플레인요거트 1개, 양파 1개, 토마토소스 1컵, 카레가루 3T, 버터 20g, 다진마늘 1T',
    steps: [
      '1. [닭 마리네이드] 닭고기에 요거트, 카레가루 1T, 후추를 섞어 30분간 재우면 육질이 놀랍도록 부드러워집니다.',
      '2. [양파 카라멜라이징] 냄비에 버터와 채 썬 양파를 넣고 중약불에서 양파가 "짙은 갈색"이 될 때까지 10분 이상 볶습니다. 이 과정이 깊은 풍미를 결정합니다.',
      '3. [고기 볶기] 재워둔 닭고기를 넣고 겉면이 익을 때까지 중불에서 볶습니다.',
      '4. [끓이기] 토마토소스와 물 반 컵, 남은 카레가루를 넣고 끓입니다.',
      '5. [졸이기] 뚜껑을 덮고 약불에서 15~20분간 뭉근하게 끓여 닭고기 속까지 양념이 배게 합니다.',
      '6. [마무리] 농도가 걸쭉해지면 소금으로 간을 하고 밥이나 난을 곁들입니다.'
    ]
  },
  {
    id: 56, category: 'Other', name: '타코',
    ingredients: ['또띠아', '다짐육', '양파', '토마토', '고수', '소금', '후추', '큐민', '라임', '식용유'],
    measure: '또띠아 6인치 3장, 다진고기 150g, 양파 1/2개, 토마토 1개, 고수, 라임, 소금, 후추, 큐민(또는 타코시즈닝), 식용유',
    steps: [
      '1. [살사 만들기] 양파, 토마토, 고수를 잘게 다져 볼에 넣고 라임즙, 소금을 섞어 상큼한 "피코 데 가요"를 만듭니다.',
      '2. [고기 볶기] 팬에 기름을 두르고 다진 고기를 볶습니다. 수분이 다 날아가고 고기 기름이 자글자글 나올 때까지 "바싹" 볶아야 식감이 좋습니다. 소금, 후추, 큐민으로 강하게 간을 하세요.',
      '3. [또띠아 굽기] 기름 없는 마른 팬에 또띠아를 올리고 중불에서 앞뒤로 10초씩만 구워 부드럽고 따뜻하게 만듭니다.',
      '4. [담기] 또띠아 -> 고기 -> 살사 순으로 올립니다.',
      '5. [팁] 사워크림이나 치즈가 있다면 고기 위에 올리고, 먹기 직전에 라임을 짜서 뿌려줍니다.'
    ]
  },
  {
    id: 57, category: 'Other', name: '피시 앤 칩스',
    ingredients: ['감자', '튀김가루', '식용유', '맥주', '흰살생선', '소금', '후추', '레몬', '타르타르소스'],
    measure: '흰살생선(대구/동태) 200g, 감자 2개, 튀김가루 1컵, 차가운 맥주(또는 탄산수) 1컵, 식용유, 레몬, 타르타르소스',
    steps: [
      '1. [감자 손질] 감자는 두툼하게 썰어 찬물에 10분간 담가 전분을 빼고, 키친타월로 물기를 완전히 제거합니다.',
      '2. [감자 1차 튀기기] 160도의 낮은 온도에서 감자를 5분간 튀겨 속을 익힌 뒤 꺼내 식힙니다.',
      '3. [바삭한 반죽 비법] 튀김가루에 "아주 차가운" 맥주를 붓고 젓가락으로 대충 섞습니다. 날가루가 보여도 괜찮으니 절대 많이 젓지 마세요(글루텐 생성을 막아 바삭해짐).',
      '4. [생선 튀기기] 생선에 마른 가루를 묻히고 반죽을 입혀 180도 기름에 넣습니다. 노릇한 황금색이 될 때까지 4~5분간 튀깁니다.',
      '5. [감자 2차 튀기기] 식혀둔 감자를 180도 고온에서 2분간 다시 튀겨 겉면을 갈색으로 바삭하게 만듭니다.',
      '6. [서빙] 기름을 탈탈 털고 뜨거울 때 소금을 뿌려 냅니다.'
    ]
  },
  {
    id: 58, category: 'Other', name: '빠에야',
    ingredients: ['쌀', '해물믹스', '닭고기', '양파', '토마토소스', '육수', '피망', '샤프란', '올리브오일'],
    measure: '불리지 않은 쌀 1.5컵, 모둠해물, 닭고기, 양파, 피망, 토마토소스 3T, 치킨육수 500ml, 샤프란(또는 카레가루), 올리브오일',
    steps: [
      '1. [재료 볶기] 넓은 팬에 오일을 두르고 닭고기, 다진 양파, 피망, 오징어를 순서대로 넣어 볶습니다.',
      '2. [쌀 볶기] 씻지 않은(혹은 씻어서 물기 뺀) 생쌀과 토마토소스, 샤프란을 넣고 쌀알이 투명해질 때까지 2분간 볶아 코팅합니다.',
      '3. [육수 붓기] 뜨거운 육수를 붓고 재료를 팬 전체에 평평하게 펼쳐줍니다. **이 순간부터는 절대 쌀을 휘젓지 마세요.**',
      '4. [익히기] 센불 5분 -> 중불 10분으로 끓입니다. 국물이 자작해지면 새우와 조개를 쌀 위에 콕콕 박아 넣습니다.',
      '5. [누룽지(소카라트) 만들기] 국물이 거의 없어지고 "타닥타닥" 소리가 나면 약불로 줄여 1~2분간 바닥을 살짝 눌립니다.',
      '6. [뜸 들이기] 불을 끄고 쿠킹호일을 덮어 5분간 뜸을 들여 쌀 속까지 고루 익힙니다.'
    ]
  },
  {
    id: 59, category: 'Other', name: '어니언 수프',
    ingredients: ['양파', '버터', '육수', '바게트', '치즈', '화이트와인', '소금', '후추'],
    measure: '양파 3개, 버터 30g, 치킨육수 500ml, 화이트와인 2T, 바게트 2쪽, 모짜렐라/그뤼에르 치즈, 소금, 후추',
    steps: [
      '1. [인내의 볶기] 냄비에 버터와 얇게 채 썬 양파를 넣고 약불에서 볶습니다. 양파가 흐물거리는 것을 넘어 "진한 갈색(카라멜 색)"이 되어 잼처럼 될 때까지 30~40분간 타지 않게 계속 저어줍니다.',
      '2. [디글레이징] 양파가 완벽하게 볶아지면 화이트와인을 부어 바닥에 눌어붙은 맛있는 성분을 긁어내며 잡내를 날립니다.',
      '3. [끓이기] 육수를 붓고 10분간 끓여 서로의 맛이 어우러지게 한 뒤 소금, 후추로 간을 합니다.',
      '4. [담기] 오븐 용기에 수프를 담고 구운 바게트를 띄웁니다.',
      '5. [치즈 토핑] 바게트 위에 치즈를 산처럼 수북하게 올립니다.',
      '6. [굽기] 200도 오븐이나 에어프라이어에서 치즈가 녹아 흘러내리고 윗면이 노릇노릇해질 때까지 굽습니다.'
    ]
  },
  {
    id: 60, category: 'Other', name: '슈니첼',
    ingredients: ['돼지고기', '밀가루', '계란', '빵가루', '버터', '식용유', '레몬', '잼', '소금', '후추'],
    measure: '돼지등심 200g, 밀가루, 계란 2개, 고운 빵가루, 버터 20g, 식용유, 레몬, 딸기잼, 소금, 후추',
    steps: [
      '1. [고기 펴기] 돼지고기를 비닐 사이에 넣고 망치나 밀대로 두드려 종이처럼 얇아질 때까지(약 3mm) 폅니다. 얇아야 바삭하고 부드럽습니다.',
      '2. [밑간 & 옷] 고기 앞뒤에 소금, 후추를 뿌린 뒤 밀가루 -> 계란물 -> 빵가루 순으로 입힙니다. 이때 빵가루를 너무 꾹꾹 누르지 않아야 튀김옷이 살아납니다.',
      '3. [튀기듯 굽기] 프라이팬에 식용유와 버터를 넉넉히(고기가 잠길 정도) 두르고 예열합니다.',
      '4. [스킬: 기름 끼얹기] 고기를 넣고 팬을 계속 흔들면서 숟가락으로 뜨거운 기름을 고기 윗면에 끼얹어주세요. 튀김옷이 공기층을 머금고 부풀어 올라(수플레 효과) 훨씬 바삭해집니다.',
      '5. [색깔 확인] 앞뒤로 "황금색"이 날 때까지 각 2~3분간 튀깁니다.',
      '6. [서빙] 기름을 빼고 접시에 담은 뒤 레몬즙을 뿌리고, 전통 방식대로 딸기잼이나 크랜베리잼을 곁들여 단짠의 조화를 즐기세요.'
      ]
    },
];
// ------------------------------------------------------------------


// --- 메인 앱 컴포넌트 ---
export default function FreshCalendar() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!auth) { setLoading(false); return; }
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  if (!auth) return <div className="h-screen flex flex-col items-center justify-center p-6 text-center bg-gray-50"><AlertTriangle className="text-red-500 w-16 h-16 mb-4" /><h1 className="text-2xl font-bold mb-2">Firebase 오류</h1><p className="text-gray-600">설정값을 확인해주세요.</p></div>;
  if (loading) return <div className="h-screen flex items-center justify-center"><Loader className="animate-spin text-green-600" /></div>;

  return user ? <AppContent user={user} /> : <AuthScreen />;
}

// --- 로그인 화면 ---
function AuthScreen() {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleAuth = async (e) => {
    e.preventDefault();
    setError(''); setLoading(true);
    try {
      if (isLogin) await signInWithEmailAndPassword(auth, email, password);
      else await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="h-screen flex items-center justify-center bg-green-50 p-6">
      <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm">
        <div className="flex justify-center mb-6"><div className="bg-green-100 p-4 rounded-full"><Refrigerator className="w-10 h-10 text-green-600" /></div></div>
        <h1 className="text-2xl font-bold text-center mb-2">Fresh Calendar</h1>
        <p className="text-center text-gray-500 mb-8 text-sm">가족과 함께 쓰는 스마트 냉장고</p>
        <form onSubmit={handleAuth} className="space-y-4">
          <input type="email" required value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 bg-gray-50 rounded-xl border focus:ring-2 focus:ring-green-500 outline-none" placeholder="이메일" />
          <input type="password" required value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 bg-gray-50 rounded-xl border focus:ring-2 focus:ring-green-500 outline-none" placeholder="비밀번호 (6자 이상)" />
          {error && <p className="text-red-500 text-xs text-center">{error}</p>}
          <button type="submit" disabled={loading} className="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold hover:bg-green-700 transition-all">
            {loading ? '로딩 중...' : (isLogin ? '로그인' : '회원가입')}
          </button>
        </form>
        <button onClick={()=>setIsLogin(!isLogin)} className="w-full mt-4 text-sm text-gray-500 underline">{isLogin ? '회원가입 하기' : '로그인 하러가기'}</button>
      </div>
    </div>
  );
}

// --- 1. PC용 사이드바 (다크모드 제거 & 알림/초기화 버튼 추가됨) ---
function DesktopSidebar({ activeTab, setActiveTab, cartCount, onReset, onLogout, onAddRequest, onNotiRequest }) {
  const menuItems = [
    { id: 'calendar', icon: <Calendar />, label: '달력' },
    { id: 'list', icon: <Refrigerator />, label: '냉장고' },
    { id: 'cart', icon: <ShoppingCart />, label: '장바구니', count: cartCount },
    { id: 'recipes', icon: <ChefHat />, label: '레시피' },
    { id: 'stats', icon: <BarChart2 />, label: '통계' },
  ];

  return (
    <aside className="hidden md:flex flex-col w-64 h-[85vh] bg-white rounded-[30px] shadow-xl p-6 mr-6 border border-gray-100">
      <div className="mb-8 px-2">
        <h1 className="text-2xl font-bold text-green-600 flex items-center gap-2">
          <Refrigerator className="w-8 h-8" />
          Fresh<br/>Calendar
        </h1>
      </div>

      <nav className="flex-1 space-y-2">
        {menuItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-bold ${
              activeTab === item.id
                ? 'bg-green-100 text-green-700 shadow-sm'
                : 'text-gray-500 hover:bg-gray-100'
            }`}
          >
            <div className="relative">
              {item.icon}
              {item.count > 0 && (
                <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">
                  {item.count}
                </span>
              )}
            </div>
            {item.label}
          </button>
        ))}
      </nav>

      <div className="pt-6 border-t space-y-2">
        <button onClick={() => onAddRequest(new Date())} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md transition-colors">
            <Plus size={20} /> 빠른 추가
        </button>
        <div className="flex gap-2 mt-4">
            {/* 🔔 알림 버튼 복구 */}
            <button onClick={onNotiRequest} className="flex-1 p-2 rounded-xl bg-yellow-50 text-yellow-600 hover:bg-yellow-100 transition-colors flex justify-center" title="알림 설정">
                <Bell size={20}/>
            </button>
            {/* 🔄 초기화 버튼 복구 */}
            <button onClick={onReset} className="flex-1 p-2 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors flex justify-center" title="초기화">
                <RefreshCcw size={20}/>
            </button>
            {/* 🚪 로그아웃 버튼 */}
            <button onClick={onLogout} className="flex-1 p-2 rounded-xl bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors flex justify-center" title="로그아웃">
                <LogOut size={20}/>
            </button>
        </div>
      </div>
    </aside>
  );
}

// --- 3. 메인 AppContent (다크모드 제거 & 기능 연결 완료) ---
function AppContent({ user }) {
  const [activeTab, setActiveTab] = useState('calendar');
  const [ingredients, setIngredients] = useState([]);
  const [cart, setCart] = useState([]);
  const [trashItems, setTrashItems] = useState([]);
  const [historyItems, setHistoryItems] = useState([]);
  const [selectedDateForAdd, setSelectedDateForAdd] = useState(null);

  // 1. 데이터 구독 (Firebase)
  useEffect(() => {
    const qIng = query(collection(db, `users/${user.uid}/ingredients`));
    const unsubIng = onSnapshot(qIng, (snap) => {
      const items = snap.docs.map(d => {
        const data = d.data();
        return { ...data, id: d.id, expiry: data.expiry?.toDate() || new Date(), addedDate: data.addedDate?.toDate() || new Date() };
      });
      setIngredients(items);
      checkExpiryAndNotify(items); 
    });

    const qCart = query(collection(db, `users/${user.uid}/cart`));
    const unsubCart = onSnapshot(qCart, (snap) => setCart(snap.docs.map(d => ({...d.data(), id: d.id}))));

    const qTrash = query(collection(db, `users/${user.uid}/trash`));
    const unsubTrash = onSnapshot(qTrash, (snap) => {
      const items = snap.docs.map(d => ({ ...d.data(), id: d.id, deletedAt: d.data().deletedAt?.toDate() }));
      setTrashItems(items);
    });

    const qHistory = query(collection(db, `users/${user.uid}/history`), orderBy('date', 'desc'));
    const unsubHistory = onSnapshot(qHistory, (snap) => {
        const items = snap.docs.map(d => ({ ...d.data(), id: d.id, date: d.data().date?.toDate() }));
        setHistoryItems(items);
    });

    return () => { unsubIng(); unsubCart(); unsubTrash(); unsubHistory(); };
  }, [user]);

  // 2. 알림 기능 (복구됨)
  const requestNotificationPermission = () => {
    if (!("Notification" in window)) { toast.error("지원하지 않는 브라우저입니다."); return; }
    Notification.requestPermission().then((permission) => {
      if (permission === "granted") { toast.success("알림 설정 완료! 🔔"); checkExpiryAndNotify(ingredients); }
    });
  };

  const checkExpiryAndNotify = (items) => {
    if (Notification.permission !== "granted") return;
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const urgentItems = items.filter(item => {
      if (!item.expiry) return false;
      const exp = new Date(item.expiry); exp.setHours(0, 0, 0, 0);
      const diffDays = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
      return diffDays >= 0 && diffDays <= 3;
    });
    if (urgentItems.length > 0) {
      // 👇 [수정] 1개일 때와 여러 개일 때 문구 분리
      const msg = urgentItems.length === 1 
        ? `${urgentItems[0].name}의 유통기한이 임박했습니다!` 
        : `${urgentItems[0].name} 외 ${urgentItems.length - 1}개 재료의 유통기한이 임박했습니다!`;
      const noti = new Notification("Fresh Calendar 🚨", { body: msg });
    noti.onclick = () => window.focus(); // 👈 알림 클릭 시 창 활성화
    }
  };

  // 3. 기능 함수들
  const addItem = async (item) => {
    try { 
      await addDoc(collection(db, `users/${user.uid}/ingredients`), { ...item, addedDate: new Date(), expiry: item.expiry, price: Number(item.price) || 0 }); 
      toast.success(`${item.name} 냉장고에 쏙! 🥬`, { icon: '✅' });
      setActiveTab('list'); 
    } catch (e) { toast.error("오류: " + e.message); }
  };

  const moveToTrash = async (ids) => {
    const batch = writeBatch(db);
    ids.forEach(id => {
      const item = ingredients.find(i => i.id === id);
      if (item) {
        const { id: itemId, ...itemData } = item;
        const trashRef = doc(collection(db, `users/${user.uid}/trash`));
        batch.set(trashRef, { ...itemData, deletedAt: new Date() });
        const historyRef = doc(collection(db, `users/${user.uid}/history`));
        batch.set(historyRef, { name: item.name, action: 'wasted', price: Number(item.price) || 0, date: new Date() });
        const ingRef = doc(db, `users/${user.uid}/ingredients`, id);
        batch.delete(ingRef);
      }
    });
    await batch.commit();
  };

  const consumeItem = async (ids) => {
      const batch = writeBatch(db);
      ids.forEach(id => {
          const item = ingredients.find(i => i.id === id);
          if (item) {
              const historyRef = doc(collection(db, `users/${user.uid}/history`));
              batch.set(historyRef, { name: item.name, action: 'used', price: Number(item.price) || 0, date: new Date() });
              const ingRef = doc(db, `users/${user.uid}/ingredients`, id);
              batch.delete(ingRef);
          }
      });
      await batch.commit();
  }

  const resetHistory = async () => {
    if (!confirm("정말 통계 기록을 초기화하시겠습니까?")) return;
    try {
      const q = query(collection(db, `users/${user.uid}/history`));
      const snapshot = await getDocs(q);
      if (snapshot.empty) { toast("기록이 없습니다."); return; }
      const batch = writeBatch(db);
      snapshot.docs.forEach((doc) => batch.delete(doc.ref));
      await batch.commit();
      toast.success("통계 초기화 완료!");
    } catch (e) { toast.error("초기화 실패"); }
  };

  const resetFridge = async () => {
    if (!confirm("정말 냉장고를 초기화하시겠습니까?")) return;
    try {
      const q = query(collection(db, `users/${user.uid}/ingredients`));
      const snapshot = await getDocs(q);
      const batch = writeBatch(db);
      snapshot.docs.forEach((doc) => batch.delete(doc.ref));
      await batch.commit();
      toast.success("냉장고 초기화 완료!");
    } catch (e) { toast.error("초기화 실패"); }
  };

  const restoreFromTrash = async (item) => {
    const batch = writeBatch(db);
    const ingRef = doc(collection(db, `users/${user.uid}/ingredients`));
    const { id, deletedAt, ...rest } = item;
    batch.set(ingRef, { ...rest });
    const trashRef = doc(db, `users/${user.uid}/trash`, item.id);
    batch.delete(trashRef);
    await batch.commit();
    toast.success("복구되었습니다!");
  };

// 🌟 [신규] 기록 없이 단순 삭제 (실수 방지용)
  const deleteItemImmediately = async (ids) => {
    if (!confirm("기록에 남기지 않고 완전히 삭제하시겠습니까?")) return;
    const batch = writeBatch(db);
    ids.forEach(id => {
      batch.delete(doc(db, `users/${user.uid}/ingredients`, id));
    });
    await batch.commit();
    toast.success("삭제되었습니다.");
  };
  
  const permanentDelete = async (id) => {
    await deleteDoc(doc(db, `users/${user.uid}/trash`, id));
    toast.success("영구 삭제됨");
  };

  const updateIngredient = async (id, data) => {
    try { await updateDoc(doc(db, `users/${user.uid}/ingredients`, id), data); } catch (e) { toast.error("수정 실패"); }
  };

  const updateCartItemDetail = async (id, data) => {
    await updateDoc(doc(db, `users/${user.uid}/cart`, id), data);
  };

  const updateCartCount = async (name, delta) => { 
    const existing = cart.find(c => c.name === name);
    if (!existing) return;
    const newCount = existing.count + delta;
    if (newCount <= 0) await deleteDoc(doc(db, `users/${user.uid}/cart`, existing.id));
    else await updateDoc(doc(db, `users/${user.uid}/cart`, existing.id), { count: newCount });
  };

  const removeItemsFromCart = async (names) => { 
    const itemsToRemove = cart.filter(c => names.includes(c.name));
    for (const item of itemsToRemove) await deleteDoc(doc(db, `users/${user.uid}/cart`, item.id));
  };

  const addToCart = async (input) => {
    let name, amount = 0, unit = 'g';
    if (typeof input === 'string') { name = input; } 
    else { name = input.name; amount = input.amount || 0; unit = input.unit || 'g'; }
    
    const existing = cart.find(c => c.name === name);
    if (existing) {
       await updateDoc(doc(db, `users/${user.uid}/cart`, existing.id), { count: existing.count + 1, amount: amount > 0 ? amount : existing.amount, unit: unit !== 'g' ? unit : existing.unit });
    } else {
       await addDoc(collection(db, `users/${user.uid}/cart`), { name, count: 1, amount, unit });
    }
    toast.success(`${name} 담기 완료! 🛒`);
  };

  const checkoutCartItems = async (selectedNames) => { 
    const itemsToCheckout = cart.filter(item => selectedNames.includes(item.name));
    const batch = writeBatch(db);

    itemsToCheckout.forEach(item => {
      let dbEntry = SHELF_LIFE_DB[item.name] || SHELF_LIFE_DB[item.name.toLowerCase()] || SHELF_LIFE_DB['default'];
      if (!dbEntry) dbEntry = { fridge: 7, price: 3000 }; 

      let shelfLife = dbEntry.fridge || 7;
      let storage = 'fridge';
      if (!dbEntry.fridge && dbEntry.freezer) storage = 'freezer';
      
      const expiry = new Date();
      expiry.setDate(expiry.getDate() + shelfLife);

      for(let i=0; i<item.count; i++) {
        const newRef = doc(collection(db, `users/${user.uid}/ingredients`));
        batch.set(newRef, {
          name: item.name, 
          category: storage, 
          location: item.location || getRecommendedZone(item.name, storage), // 👈 사용자가 지정한 위치 우선, 없으면 추천 위치
          expiry: expiry, 
          addedDate: new Date(),
          price: item.price !== undefined ? Number(item.price) : (dbEntry.price || 0),
          amount: item.amount !== undefined ? Number(item.amount) : 0,
          unit: item.unit || 'g'
        });
      }
      const cartRef = doc(db, `users/${user.uid}/cart`, item.id);
      batch.delete(cartRef);
    });
    
    await batch.commit();
    toast.success("냉장고로 이동 완료!");
    setActiveTab('list');
  };

  const getRiskLevel = (expiryDate, itemName = '') => {
    if (!expiryDate) return 'safe';
    const today = new Date();
    today.setHours(0,0,0,0);
    const expiry = new Date(expiryDate);
    expiry.setHours(0,0,0,0);
    
    const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    const settings = SHELF_LIFE_DB[itemName] || SHELF_LIFE_DB[itemName.replace(/\s+/g, '')] || SHELF_LIFE_DB['default'] || { risk: { danger: 3, warning: 7 } };
    const { danger, warning } = settings.risk || { danger: 3, warning: 7 };

    if (diffDays < 0) return 'expired';
    if (diffDays <= danger) return 'danger'; 
    if (diffDays <= warning) return 'warning'; 
    return 'safe';
  };

  return (
    <div className="min-h-screen bg-gray-100 font-sans flex justify-center text-gray-800">
      <Toaster position="top-center" toastOptions={{ style: { borderRadius: '20px', background: '#222', color: '#fff', fontSize: '14px' } }} />

      <div className="w-full md:max-w-6xl md:grid md:grid-cols-[400px_1fr] md:gap-8 md:p-8 h-screen md:h-auto">
        
        {/* 1. PC용 사이드바 */}
        <DesktopSidebar 
            activeTab={activeTab} 
            setActiveTab={setActiveTab} 
            cartCount={cart.reduce((s, i) => s + i.count, 0)}
            onReset={resetFridge}
            onLogout={() => signOut(auth)}
            onAddRequest={(d) => { setSelectedDateForAdd(d); setActiveTab('add'); }}
            onNotiRequest={requestNotificationPermission} // 알림 버튼 연결
        />

        {/* 2. 메인 앱 화면 (모바일 뷰 & PC 메인 컨텐츠) */}
        <div className="bg-white md:rounded-[30px] shadow-2xl flex flex-col h-full md:h-[85vh] overflow-hidden border-x md:border-0 relative max-w-md mx-auto md:mx-0 w-full">
          <header className="md:hidden bg-green-600 text-white p-5 pt-6 shadow-md z-10 flex justify-between items-center">
            <div>
              <h1 className="text-xl font-bold flex items-center gap-2"><Refrigerator /> Fresh Calendar</h1>
              <p className="text-green-100 text-xs mt-1 opacity-80">{user.email}</p>
            </div>
            {/* 👇 알림, 초기화, 로그아웃 버튼 3개를 모두 추가함 */}
            <div className="flex gap-2">
              <button onClick={requestNotificationPermission} className="p-2 bg-green-700 rounded-full hover:bg-green-800 transition-colors"><Bell size={18} /></button>
              <button onClick={resetFridge} className="p-2 bg-green-700 rounded-full hover:bg-red-600 transition-colors"><RefreshCcw size={18} /></button>
              <button onClick={() => signOut(auth)} className="p-2 bg-green-700 rounded-full hover:bg-green-800 transition-colors"><LogOut size={18} /></button>
            </div>    
          </header>

          <main className="flex-1 overflow-y-auto bg-gray-50 relative scroll-smooth">
            {activeTab === 'calendar' && <CalendarView ingredients={ingredients} getRiskLevel={getRiskLevel} onDateSelect={(d) => setSelectedDateForAdd(d)} onAddRequest={(d) => { setSelectedDateForAdd(d); setActiveTab('add'); }} />}
            {activeTab === 'list' && <FridgeListView 
            ingredients={ingredients} 
            getRiskLevel={getRiskLevel} 
            moveToTrash={moveToTrash} 
            consumeItem={consumeItem} 
            deleteItemImmediately={deleteItemImmediately} // 👈 이 부분이 누락되어 있었습니다. 추가하세요.
            updateIngredient={updateIngredient} 
            onOpenTrash={() => setActiveTab('trash')} 
            onAddRequest={() => { setSelectedDateForAdd(new Date()); setActiveTab('add'); }} 
        />}
            {activeTab === 'trash' && <TrashView trashItems={trashItems} onRestore={restoreFromTrash} onPermanentDelete={permanentDelete} onClose={() => setActiveTab('list')} />}
            {activeTab === 'recipes' && <RecipeView ingredients={ingredients} onAddToCart={addToCart} recipes={RECIPE_FULL_DB} user={user} />} 
            {activeTab === 'cart' && <ShoppingCartView cart={cart} ingredients={ingredients} onUpdateCount={updateCartCount} onRemove={removeItemsFromCart} onCheckout={checkoutCartItems} onUpdateDetail={updateCartItemDetail} onAdd={addToCart} />}
            {activeTab === 'stats' && <InsightsView ingredients={ingredients} onAddToCart={addToCart} history={historyItems} onResetHistory={resetHistory} />}
            {activeTab === 'add' && <AddItemModal onClose={() => setActiveTab('calendar')} onAdd={addItem} initialDate={selectedDateForAdd} />}
          </main>

          <nav className="bg-white border-t flex justify-between px-6 py-3 pb-6 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] md:hidden">
            <NavBtn active={activeTab==='calendar'} onClick={()=>setActiveTab('calendar')} icon={<Calendar />} label="달력" />
            <NavBtn active={activeTab==='list'} onClick={()=>setActiveTab('list')} icon={<Refrigerator />} label="냉장고" />
            <NavBtn active={activeTab==='cart'} onClick={()=>setActiveTab('cart')} icon={<ShoppingCart />} label="카트" count={cart.reduce((sum, item) => sum + item.count, 0)} />
            <NavBtn active={activeTab==='recipes'} onClick={()=>setActiveTab('recipes')} icon={<ChefHat />} label="레시피" />
            <NavBtn active={activeTab==='stats'} onClick={()=>setActiveTab('stats')} icon={<BarChart2 />} label="통계" />
          </nav>
        </div>

        {/* 3. 오른쪽: PC 전용 대시보드 (통계 컴포넌트 재사용 및 가로 배치 적용) */}
        <div className="hidden md:flex flex-col gap-6 h-[85vh] flex-1">
           <div className="bg-white rounded-[30px] shadow-xl p-8 flex-1 overflow-y-auto">
              <h2 className="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2"><TrendingUp className="text-green-600" /> 나의 키친 대시보드</h2>
              
              {/* 대시보드 내용은 InsightsView를 그대로 사용하여 가로 배치를 적용 */}
              <InsightsView ingredients={ingredients} onAddToCart={addToCart} history={historyItems} onResetHistory={resetHistory} />
              
              {/* 하단 추가 배너 */}
              <div className="mt-6 p-6 bg-green-50 border border-green-100 rounded-3xl flex items-center justify-between">
                 <div>
                    <h3 className="font-bold text-green-800 mb-1 flex items-center gap-2"><ChefHat size={20}/> 추천 메뉴 바로가기</h3>
                    <p className="text-sm text-green-600">유통기한 임박 재료로 만들 수 있는 요리를 확인하세요.</p>
                 </div>
                 <button onClick={() => setActiveTab('recipes')} className="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition-colors shadow-md">
                    레시피 보러가기
                 </button>
              </div>
           </div>
        </div>

      </div>
    </div>
  );
}
// NavBtn 컴포넌트는 기존 파일 맨 아래에 있는 거 그대로 쓰면 돼!

// --- 캘린더 뷰 ---
function CalendarView({ ingredients, getRiskLevel, onAddRequest, onDateSelect }) {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDayInfo, setSelectedDayInfo] = useState(null);

  const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
  const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);

  const getItemsForDate = (day) => ingredients.filter(i => {
    if (!i.expiry) return false;
    const d = new Date(i.expiry);
    return d.getDate() === day && d.getMonth() === month && d.getFullYear() === year;
  });

  return (
    <div className="p-4">
      <div className="flex justify-between items-center mb-6">
        <button onClick={()=>setCurrentDate(new Date(year, month-1, 1))} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full"><ChevronLeft /></button>
        <h2 className="font-bold text-lg text-gray-800">{year}년 {month+1}월</h2>
        <button onClick={()=>setCurrentDate(new Date(year, month+1, 1))} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full"><ChevronRight /></button>
      </div>
      <div className="grid grid-cols-7 text-center text-xs text-gray-400 font-bold mb-2">
        {['일','월','화','수','목','금','토'].map(d=><div key={d}>{d}</div>)}
      </div>
      <div className="grid grid-cols-7 gap-1">
        {Array.from({length: firstDay}).map((_, i) => <div key={`empty-${i}`} className="h-16" />)}
        {Array.from({length: daysInMonth}).map((_, i) => {
          const day = i + 1;
          const dayItems = getItemsForDate(day);
          // 👇 [수정] 연도(FullYear)까지 비교해야 정확한 '오늘'이 표시됨
          const now = new Date();
          const isToday = day === now.getDate() && month === now.getMonth() && year === now.getFullYear();
          return (
            <div key={day} onClick={() => { 
                setSelectedDayInfo({ day, items: dayItems, dateObj: new Date(year, month, day) });
                if(onDateSelect) onDateSelect(new Date(year, month, day)); 
            }} className={`h-16 border rounded-xl p-1 relative flex flex-col items-center justify-between cursor-pointer transition-colors hover:bg-green-50 ${isToday ? 'bg-green-50 border-green-400' : 'bg-white border-gray-100'}`}>
              <span className={`text-xs font-bold ${isToday ? 'text-green-700' : 'text-gray-600'}`}>{day}</span>
              <div className="flex flex-wrap justify-center gap-1 w-full px-0.5 mb-1">
                {dayItems.slice(0, 4).map((item, idx) => {
                  const risk = getRiskLevel(item.expiry, item.name);
                  return <div key={idx} className={`w-1.5 h-1.5 rounded-full ${risk === 'danger' || risk === 'expired' ? 'bg-red-500 animate-pulse' : risk === 'warning' ? 'bg-yellow-400' : 'bg-green-400'}`} style={{ animationDuration: risk === 'danger' ? '1s' : '0s' }} />;
                })}
                {dayItems.length > 4 && <span className="text-[8px] leading-none text-gray-400">+</span>}
              </div>
            </div>
          );
        })}
      </div>
      {selectedDayInfo && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 animate-in fade-in" onClick={() => setSelectedDayInfo(null)}>
          <div className="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-gray-800">{month+1}월 {selectedDayInfo.day}일 만료 목록</h3><button onClick={() => setSelectedDayInfo(null)}><X className="text-gray-400" /></button></div>
            <div className="space-y-2 max-h-60 overflow-y-auto mb-4">
              {selectedDayInfo.items.length === 0 ? <p className="text-gray-400 text-center py-4 text-sm">만료되는 상품이 없습니다.</p> : selectedDayInfo.items.map(item => (
                  <div key={item.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                    <div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${getRiskLevel(item.expiry, item.name) === 'danger' ? 'bg-red-500' : 'bg-green-400'}`} /><span className="font-bold text-gray-700">{item.name}</span></div><span className="text-xs text-gray-500 capitalize">{item.category}</span>
                  </div>
              ))}
            </div>
            <button onClick={() => { onAddRequest(selectedDayInfo.dateObj); setSelectedDayInfo(null); }} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><Plus size={18} /> 이 날짜에 추가하기</button>
          </div>
        </div>
      )}
    </div>
  );
}

// --- 냉장고 목록 뷰 (필터 & 정렬 추가 버전) ---
function FridgeListView({ ingredients, getRiskLevel, moveToTrash, consumeItem, deleteItemImmediately, updateIngredient, onOpenTrash, onAddRequest }) {
  const [filter, setFilter] = useState('all');
  const [sort, setSort] = useState('expiry');
  const [selectedIds, setSelectedIds] = useState([]);
  const [viewMode, setViewMode] = useState('list');
  const [editingItem, setEditingItem] = useState(null);

  const filtered = ingredients.filter(item => {
    if (filter === 'all') return true;
    return item.category === filter;
  });

  const sorted = [...filtered].sort((a, b) => {
    if (sort === 'expiry') return (a.expiry || 0) - (b.expiry || 0);
    if (sort === 'name') return a.name.localeCompare(b.name);
    if (sort === 'newest') return (b.addedDate || 0) - (a.addedDate || 0);
    return 0;
  });

  const toggleSelect = (id) => { if (selectedIds.includes(id)) setSelectedIds(selectedIds.filter(itemId => itemId !== id)); else setSelectedIds([...selectedIds, id]); };
  
  const toggleSelectAll = () => { 
    if (selectedIds.length === sorted.length && sorted.length > 0) setSelectedIds([]); 
    else setSelectedIds(sorted.map(i => i.id)); 
  };

  const handleWasteSelected = (e) => { e.stopPropagation(); if (selectedIds.length === 0) return; moveToTrash(selectedIds); setSelectedIds([]); toast.success('비워냈습니다!'); };
  const handleConsumeSelected = (e) => { e.stopPropagation(); if (selectedIds.length === 0) return; consumeItem(selectedIds); setSelectedIds([]); toast.success('맛있게 드셨군요! 😋'); };

  return (
    <div className="p-4 pb-24">
      {/* 헤더 */}
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-lg font-bold flex items-center gap-2 text-gray-800">내 냉장고 <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">{sorted.length}</span></h2>
        <div className="flex bg-gray-100 rounded-lg p-1 mr-2">
            <button onClick={() => setViewMode('list')} className={`px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-1 transition-all ${viewMode === 'list' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}><Menu size={14}/> 목록</button>
            <button onClick={() => setViewMode('map')} className={`px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-1 transition-all ${viewMode === 'map' ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`}><LayoutGrid size={14}/> 지도</button>
        </div>
        <div className="flex gap-2">
            {/* 수정됨: 함수 호출 형태로 전달하여 이벤트 객체 오류 방지 */}
            <button onClick={() => onAddRequest(new Date())} className="p-2 bg-green-600 text-white rounded-full hover:bg-green-700 shadow-sm"><Plus size={18} /></button>
            <button onClick={onOpenTrash} className="p-2 text-gray-400 hover:text-red-500 bg-white rounded-full border border-gray-100 shadow-sm"><Trash2 size={18} /></button>
        </div>
      </div>

      {viewMode === 'map' ? (
        <FridgeMap ingredients={ingredients} onItemClick={(item) => setEditingItem(item)} />
      ) : (
        <>
          {/* 필터 & 정렬 */}
          <div className="flex flex-col gap-3 mb-4">
            <div className="flex bg-gray-100 p-1 rounded-xl">
              {['all', 'fridge', 'freezer', 'pantry'].map(f => (<button key={f} onClick={() => setFilter(f)} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${filter === f ? 'bg-white text-green-700 shadow-sm' : 'text-gray-400'}`}>{f === 'all' ? '전체' : f === 'fridge' ? '냉장' : f === 'freezer' ? '냉동' : '실온'}</button>))}
            </div>
            <div className="flex justify-end">
                <select value={sort} onChange={e => setSort(e.target.value)} className="bg-white border border-gray-200 text-xs font-bold px-3 py-1.5 rounded-lg outline-none text-gray-600">
                    <option value="expiry">⏳ 유통기한 급한순</option><option value="newest">✨ 최근 등록순</option><option value="name">가나다 이름순</option>
                </select>
            </div>
          </div>

          {/* 선택 액션 및 리스트 */}
          <div className="flex gap-2 mb-4">
              <button onClick={toggleSelectAll} className="text-xs bg-white border border-gray-200 text-gray-600 px-3 py-2.5 rounded-xl font-bold flex items-center gap-1 shadow-sm flex-1 justify-center">{selectedIds.length === sorted.length && sorted.length > 0 ? <CheckSquare size={14} className="text-green-600" /> : <Square size={14} />} 전체</button>
              {selectedIds.length > 0 && (
        <>
          <button onClick={handleConsumeSelected} className="text-xs bg-green-600 text-white px-3 py-2.5 rounded-xl font-bold shadow-md flex-[2] flex items-center justify-center gap-1"><Utensils size={14} /> 먹었어요</button>
          <button onClick={handleWasteSelected} className="text-xs bg-red-100 text-red-600 px-3 py-2.5 rounded-xl font-bold shadow-sm flex-1 flex items-center justify-center gap-1"><Trash2 size={14} /> 버릴래요</button>
          {/* 🌟 [추가] 단순 삭제 버튼 */}
          <button onClick={(e) => {e.stopPropagation(); deleteItemImmediately(selectedIds); setSelectedIds([]);}} className="text-xs bg-gray-200 text-gray-600 px-3 py-2.5 rounded-xl font-bold shadow-sm flex-1 flex items-center justify-center gap-1"><X size={14} /> 삭제</button>
        </>
      )}
  </div>
   
          <div className="space-y-3">
            {sorted.map(item => {
                const risk = getRiskLevel(item.expiry, item.name);
                // 수정됨: Date 타입 변환 후 연산
                const diff = item.expiry ? Math.ceil((new Date(item.expiry).getTime() - new Date().setHours(0,0,0,0)) / (86400000)) : 0;
                const isSelected = selectedIds.includes(item.id);
                return (
                <div key={item.id} className={`bg-white p-4 rounded-2xl border border-gray-100 shadow-sm transition-all flex items-center justify-between group cursor-pointer ${isSelected ? 'ring-2 ring-green-500 bg-green-50' : 'hover:border-green-300'}`}>
                    <div className="flex items-center gap-3 flex-1">
                      <div className="cursor-pointer p-1" onClick={(e) => { e.stopPropagation(); toggleSelect(item.id); }}>{isSelected ? <CheckSquare size={20} className="text-green-600"/> : <Square size={20} className="text-gray-300"/>}</div>
                      <div className="flex-1 cursor-pointer" onClick={() => setEditingItem(item)}>
                        <div className={`w-1.5 h-10 rounded-full float-left mr-3 ${risk === 'danger' ? 'bg-red-500' : risk === 'warning' ? 'bg-yellow-400' : 'bg-green-400'}`}></div>
                        <div>
                          <h3 className="font-bold text-gray-800 flex items-center gap-1">{item.name} <span className="text-[9px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border truncate max-w-[100px]">{item.location ? item.location.split(':')[0] : item.category}</span></h3>
                          <p className={`text-xs mt-0.5 ${risk === 'danger' ? 'text-red-500 font-bold' : 'text-gray-500'}`}>{diff < 0 ? '만료됨' : diff === 0 ? '오늘 만료' : `D-${diff}`}</p>
                        </div>
                      </div>
                    </div>
                </div>
                );
            })}
            {sorted.length === 0 && <div className="text-center py-20 text-gray-400">표시할 재료가 없어요.<br/>필터를 변경해보세요!</div>}
          </div>
        </>
      )}
      {editingItem && <EditIngredientModal item={editingItem} onClose={() => setEditingItem(null)} onUpdate={updateIngredient} />}
    </div>
  );
}

// --- 휴지통 뷰 (다크 모드 적용 완료) ---
function TrashView({ trashItems, onRestore, onPermanentDelete, onClose }) {
  return (
    <div className="p-4 pb-20 animate-in slide-in-from-right duration-300">
      <div className="flex items-center gap-2 mb-6">
        <button onClick={onClose}><ArrowLeft className="text-gray-600 dark:text-gray-400" /></button>
        <h2 className="text-lg font-bold flex items-center gap-2 text-red-600 dark:text-red-400">
          <Trash2 size={20} /> 휴지통
        </h2>
      </div>
      <div className="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg text-xs text-red-700 dark:text-red-300 mb-4 flex items-start gap-2">
        <AlertCircle size={16} className="mt-0.5 shrink-0" />
        <span>실수로 삭제했나요? 여기서 복구할 수 있습니다.</span>
      </div>
      <div className="space-y-3">
        {trashItems.length === 0 ? (
          <div className="text-center py-20 text-gray-400">휴지통이 비어있습니다.</div>
        ) : (
          trashItems.map(item => (
            <div key={item.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 flex justify-between items-center shadow-sm opacity-75 hover:opacity-100 transition-opacity">
              <div>
                <h3 className="font-bold text-gray-700 dark:text-gray-300 line-through decoration-gray-400">{item.name}</h3>
                <p className="text-xs text-gray-400">삭제일: {item.deletedAt ? new Date(item.deletedAt).toLocaleDateString() : '알 수 없음'}</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => onRestore(item)} className="p-2 bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-green-100 dark:hover:bg-green-900/50"><Undo2 size={14} /> 복구</button>
                <button onClick={() => { if(confirm('정말 영구 삭제하시겠습니까?')) onPermanentDelete(item.id); }} className="p-2 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 rounded-lg text-xs font-bold hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400">영구 삭제</button>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );
}

// --- AddItemModal 전체 수정 (문법 오류 수정됨) ---
function AddItemModal({ onClose, onAdd, initialDate }) {
  const [name, setName] = useState('');
  const [category, setCategory] = useState('fridge');
  const [expiry, setExpiry] = useState(
    initialDate 
      ? new Date(initialDate.getTime() - (initialDate.getTimezoneOffset() * 60000)).toISOString().split('T')[0] 
      : new Date(Date.now() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0]
  );
  const [price, setPrice] = useState('');
  const [amount, setAmount] = useState('');
  const [unit, setUnit] = useState('g');
  const [location, setLocation] = useState(ZONES.FRIDGE_MAIN_2);

  const setQuickExpiry = (days) => {
    const date = new Date();
    date.setDate(date.getDate() + days);
    setExpiry(date.toISOString().split('T')[0]);
  };

  const handleLocationChange = (newLoc) => {
    setLocation(newLoc);
    if (newLoc.includes('냉동')) setCategory('freezer');
    else if (newLoc.includes('실온') || newLoc.includes('팬트리')) setCategory('pantry');
    else setCategory('fridge'); 
  };

  const handleNameChange = (val) => {
    setName(val);
    const dbItem = SHELF_LIFE_DB[val] || SHELF_LIFE_DB[val.replace(/\s/g, '')];
    if (dbItem) {
      let autoCat = 'fridge';
      if (dbItem.freezer && !dbItem.fridge) autoCat = 'freezer';
      else if (dbItem.pantry) autoCat = 'pantry';
      
      setCategory(autoCat);
      setLocation(getRecommendedZone(val, autoCat)); 

      const days = dbItem.fridge || dbItem.freezer || dbItem.pantry || 7;
      const date = new Date();
      date.setDate(date.getDate() + days);
      setExpiry(date.toISOString().split('T')[0]);

      if (dbItem.price) setPrice(dbItem.price);
      if (dbItem.unit) {
         const extractedUnit = dbItem.unit.replace(/[0-9.]/g, ''); 
         if (['g', 'kg', 'ml', 'L', '개', '봉'].includes(extractedUnit)) setUnit(extractedUnit);
         const extractedAmount = parseFloat(dbItem.unit);
         if (extractedAmount) setAmount(extractedAmount);
      }
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!name) return;
    onAdd({ name, expiry: new Date(expiry), category, location, price: Number(price) || 0, amount: Number(amount) || 0, unit: unit });
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200" onClick={onClose}>
      <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-100 transition-transform" onClick={e => e.stopPropagation()}>
        
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-xl font-bold text-gray-800">새 재료 추가</h2>
          <button onClick={onClose} className="p-2 bg-gray-100 dark:bg-gray-700 rounded-full text-gray-500 hover:bg-gray-200 transition-colors">
            <X size={20} className="dark:text-white"/>
          </button>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1">제품명</label>
            <input type="text" required autoFocus value={name} onChange={(e) => handleNameChange(e.target.value)} className="w-full p-4 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-2xl text-lg font-bold border-2 border-transparent focus:border-green-500 focus:bg-white dark:focus:bg-gray-600 outline-none transition-all placeholder:font-normal" placeholder="예: 우유, 두부" />
          </div>

          <div className="flex gap-2">
            {['fridge', 'freezer', 'pantry'].map(cat => (
              <button key={cat} type="button" onClick={() => setCategory(cat)} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${category === cat ? 'bg-gray-800 dark:bg-green-600 text-white shadow-lg scale-105' : 'bg-gray-100 dark:bg-gray-700 text-gray-400 hover:bg-gray-200'}`}>
                {cat === 'fridge' ? '냉장' : cat === 'freezer' ? '냉동' : '실온'}
              </button>
            ))}
          </div>

          <div>
            <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">상세 위치 설정</label>
            <select value={location} onChange={(e)=>handleLocationChange(e.target.value)} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none text-sm font-bold">
                <optgroup label="🧊 냉장실">
                    {Object.values(ZONES).filter(z => z.includes('냉장')).map(z => <option key={z} value={z}>{z}</option>)}
                </optgroup>
                <optgroup label="❄️ 냉동실">
                    {Object.values(ZONES).filter(z => z.includes('냉동')).map(z => <option key={z} value={z}>{z}</option>)}
                </optgroup>
                <optgroup label="🏠 기타">
                    <option value={ZONES.PANTRY}>{ZONES.PANTRY}</option>
                </optgroup>
            </select>
          </div>

          <div className="flex gap-2">
            <div className="flex-[2]">
              <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1">용량/수량</label>
              <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl border border-gray-100 dark:border-gray-600 focus:border-green-500 outline-none" placeholder="0" />
            </div>
            <div className="flex-1">
              <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1">단위</label>
              <select value={unit} onChange={e => setUnit(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl border border-gray-100 dark:border-gray-600 focus:border-green-500 outline-none text-center appearance-none">
                <option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="개">개</option><option value="봉">봉</option>
              </select>
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1">구매 가격 (원)</label>
            <div className="relative">
              <span className="absolute left-4 top-3.5 text-gray-400">₩</span>
              <input type="number" value={price} onChange={(e) => setPrice(e.target.value)} className="w-full p-3 pl-8 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl border border-gray-100 dark:border-gray-600 focus:border-green-500 outline-none" placeholder="0" />
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1">유통기한</label>
            <input type="date" required value={expiry} onChange={(e) => setExpiry(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl border border-gray-100 dark:border-gray-600 focus:border-green-500 outline-none font-medium mb-2" />
            {/* 👇 빠른 설정 버튼 */}
            <div className="flex flex-wrap gap-2">
                <button type="button" onClick={() => setQuickExpiry(3)} className="px-3 py-1.5 bg-red-50 text-red-500 rounded-lg text-xs font-bold border border-red-100 hover:bg-red-100">🥩 고기(3일)</button>
                <button type="button" onClick={() => setQuickExpiry(7)} className="px-3 py-1.5 bg-green-50 text-green-600 rounded-lg text-xs font-bold border border-green-100 hover:bg-green-100">🥦 야채(7일)</button>
                <button type="button" onClick={() => setQuickExpiry(14)} className="px-3 py-1.5 bg-yellow-50 text-yellow-600 rounded-lg text-xs font-bold border border-yellow-100 hover:bg-yellow-100">🥛 유제품(2주)</button>
                <button type="button" onClick={() => setQuickExpiry(30)} className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold border border-blue-100 hover:bg-blue-100">❄️ 냉동(1달)</button>
            </div>
          </div>

          <button type="submit" className="w-full bg-green-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg hover:bg-green-700 active:scale-95 transition-all mt-4 flex items-center justify-center gap-2">
            <Plus size={24} strokeWidth={3} /> 냉장고에 넣기
          </button>
        </form>
      </div>
    </div>
  );
}

// --- 장바구니 뷰 (수정됨: 직접 추가 기능 포함) ---
function ShoppingCartView({ cart, ingredients, onUpdateCount, onRemove, onCheckout, onUpdateDetail, onAdd }) {
  const [selectedNames, setSelectedNames] = useState([]);
  const [newItemName, setNewItemName] = useState('');
  
  // 🟢 [New] 냉장고 털기(중복 체크) 모달 상태
  const [pantryCheckModal, setPantryCheckModal] = useState({ isOpen: false, duplicates: [] });

  const toggleSelection = (name) => { if (selectedNames.includes(name)) setSelectedNames(selectedNames.filter(n => n !== name)); else setSelectedNames([...selectedNames, name]); };
  const toggleSelectAll = () => { if (selectedNames.length === cart.length && cart.length > 0) setSelectedNames([]); else setSelectedNames(cart.map(i => i.name)); };

  const getDefaultUnit = (name) => {
    const cleanName = name.replace(/\s+/g, '');
    const dbInfo = SHELF_LIFE_DB[name] || SHELF_LIFE_DB[cleanName]; 
    if (!dbInfo || !dbInfo.unit) return 'g';
    if (/[구개알마리송이통단봉장]/.test(dbInfo.unit)) return '개';
    if (/[Lml]/.test(dbInfo.unit)) return 'ml';
    return 'g';
  };

  const calculateAutoPrice = (name, inputAmount, inputUnit) => {
    const cleanName = name.replace(/\s+/g, '');
    const dbInfo = SHELF_LIFE_DB[name] || SHELF_LIFE_DB[cleanName] || SHELF_LIFE_DB['default'];
    if (!dbInfo || !dbInfo.unit || !dbInfo.price) return null;

    let dbUnitStr = dbInfo.unit || '100g'; 
    let dbAmount = parseFloat(dbUnitStr.replace(/[^0-9.]/g, '')) || 1;
    if (dbUnitStr.includes('kg') || dbUnitStr.includes('L')) dbAmount *= 1000;

    let currentAmount = parseFloat(inputAmount) || 0;
    if (inputUnit === 'kg' || inputUnit === 'L') currentAmount *= 1000;

    if (dbAmount === 0) return dbInfo.price;
    const estimated = (dbInfo.price / dbAmount) * currentAmount;
    return Math.round(estimated / 10) * 10;
  };

  const handleManualAdd = (e) => {
    e.preventDefault();
    if (!newItemName.trim()) return;
    // DB에서 기본 단위 정보 조회
    const dbItem = SHELF_LIFE_DB[newItemName.trim()] || SHELF_LIFE_DB[newItemName.trim().replace(/\s/g, '')];
    let defaultUnit = 'g';
    if (dbItem && dbItem.unit) {
        const unitMatch = dbItem.unit.match(/[a-zA-Z가-힣]+/);
        if (unitMatch) defaultUnit = unitMatch[0];
    }
    onAdd({ name: newItemName.trim(), unit: defaultUnit });
    setNewItemName('');
  };

  const handleAmountChange = (item, newAmount) => {
      const updates = { amount: newAmount };
      const currentUnit = item.unit || getDefaultUnit(item.name);
      const autoPrice = calculateAutoPrice(item.name, newAmount, currentUnit);
      if (autoPrice !== null) updates.price = autoPrice;
      onUpdateDetail(item.id, updates);
  };

  const handleUnitChange = (item, newUnit) => {
      const updates = { unit: newUnit };
      const autoPrice = calculateAutoPrice(item.name, item.amount || 0, newUnit);
      if (autoPrice !== null) updates.price = autoPrice;
      onUpdateDetail(item.id, updates);
  };

  // 🟢 [New] 냉장고로 이동 요청 (중복 검사 로직)
  const handleCheckoutRequest = () => {
    // 냉장고에 있는 재료와 이름이 겹치는지 확인
    const duplicates = selectedNames.filter(cartItemName => 
      ingredients.some(ing => ing.name.replace(/\s/g, '') === cartItemName.replace(/\s/g, ''))
    );

    if (duplicates.length > 0) {
      setPantryCheckModal({ isOpen: true, duplicates }); // 중복 있으면 모달 띄움
    } else {
      onCheckout(selectedNames); // 중복 없으면 바로 이동
    }
  };

  const confirmPantryCheck = (finalSelection) => {
    onCheckout(finalSelection);
    setPantryCheckModal({ isOpen: false, duplicates: [] });
  };

  return (
    <div className="p-4 pb-20">
      <h2 className="text-lg font-bold mb-4 flex items-center gap-2 dark:text-gray-100"><ShoppingCart className="text-green-600" /> 장바구니</h2>
      
      <form onSubmit={handleManualAdd} className="flex gap-2 mb-6">
        <input 
          type="text" 
          value={newItemName}
          onChange={(e) => setNewItemName(e.target.value)}
          placeholder="필요한 재료 직접 입력..." 
          className="flex-1 p-3 bg-white dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl outline-none focus:border-green-500 shadow-sm placeholder:text-gray-400"
        />
        <button type="submit" className="bg-gray-800 text-white p-3 rounded-xl font-bold hover:bg-black transition-colors">
          <Plus size={20} />
        </button>
      </form>

      {cart.length === 0 ? <div className="text-center py-10 text-gray-400">장바구니가 비었습니다.</div> : (
        <div className="space-y-3">
          <div className="flex items-center justify-between mb-2"><button onClick={toggleSelectAll} className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300"><CheckSquare size={18} /> 전체 선택</button>{selectedNames.length > 0 && <button onClick={()=>onRemove(selectedNames)} className="text-xs text-red-500">선택 삭제</button>}</div>
          {cart.map(item => {
            const currentUnit = item.unit || getDefaultUnit(item.name);
            return (
            <div key={item.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl border dark:border-gray-700 shadow-sm space-y-3">
                <div className="flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <button onClick={()=>toggleSelection(item.name)}>{selectedNames.includes(item.name) ? <CheckSquare className="text-green-600"/> : <Square className="text-gray-300"/>}</button>
                        <span className="font-bold text-lg dark:text-gray-100">{item.name}</span>
                    </div>
                    <div className="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <button onClick={() => onUpdateCount(item.name, -1)} className="p-1 px-2 dark:text-white">-</button>
                        <span className="px-2 text-sm font-bold dark:text-white">{item.count}</span>
                        <button onClick={() => onUpdateCount(item.name, 1)} className="p-1 px-2 dark:text-white">+</button>
                    </div>
                </div>

                <div className="flex gap-2 bg-gray-50 dark:bg-gray-700 p-2 rounded-lg">
                    <div className="flex-1">
                        <label className="text-[10px] text-gray-500 dark:text-gray-400 block">용량/수량</label>
                        <div className="flex gap-1">
                            <input type="number" placeholder="0" value={item.amount || ''} onChange={(e) => handleAmountChange(item, e.target.value)} className="w-full bg-white dark:bg-gray-600 dark:text-white border dark:border-gray-500 rounded px-1 py-1 text-sm outline-none focus:border-green-500" />
                            <select value={currentUnit} onChange={(e) => handleUnitChange(item, e.target.value)} className="bg-white dark:bg-gray-600 dark:text-white border dark:border-gray-500 rounded text-xs">
                                <option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="개">개</option><option value="봉">봉</option>
                            </select>
                        </div>
                    </div>
                    <div className="flex-1">
                        <label className="text-[10px] text-gray-500 dark:text-gray-400 block">예상 가격(원)</label>
                        <input type="number" placeholder="0" value={item.price || ''} onChange={(e) => onUpdateDetail(item.id, { price: e.target.value })} className="w-full bg-white dark:bg-gray-600 dark:text-white border dark:border-gray-500 rounded px-1 py-1 text-sm outline-none focus:border-green-500" />
                    </div>
                </div>
                {/* 👇 위치 지정 드롭다운 추가 */}
                <select value={item.location || ''} onChange={(e) => onUpdateDetail(item.id, { location: e.target.value })} className="w-full mt-2 p-2 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-lg border dark:border-gray-600 text-xs outline-none">
                    <option value="">📍 (자동 추천) {getRecommendedZone(item.name, 'fridge').split(':')[0]}</option>
                    <optgroup label="🧊 냉장실">
                        {Object.values(ZONES).filter(z => z.includes('냉장')).map(z => <option key={z} value={z}>{z}</option>)}
                    </optgroup>
                    <optgroup label="❄️ 냉동실">
                        {Object.values(ZONES).filter(z => z.includes('냉동')).map(z => <option key={z} value={z}>{z}</option>)}
                    </optgroup>
                    <option value={ZONES.PANTRY}>{ZONES.PANTRY}</option>
                </select>
            </div>
          )})}
          
          {/* 🟢 [Changed] 냉장고로 이동 버튼 (핸들러 변경됨) */}
          <button onClick={handleCheckoutRequest} disabled={selectedNames.length===0} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold mt-4 disabled:bg-gray-300">냉장고로 이동</button>
        </div>
      )}

      {/* 🟢 [New] Pantry Check 모달 */}
      {pantryCheckModal.isOpen && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-in fade-in">
           <div className="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
              <h3 className="text-lg font-bold mb-2 dark:text-white">잠깐! 냉장고에 이미 있어요 🧐</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                 아래 재료들은 이미 냉장고에 있는 것 같습니다.<br/>제외하고 넣을까요?
              </p>
              <div className="bg-gray-50 dark:bg-gray-700 rounded-xl p-3 mb-4 max-h-40 overflow-y-auto">
                 {pantryCheckModal.duplicates.map(name => (
                    <div key={name} className="flex justify-between items-center py-2 border-b dark:border-gray-600 last:border-0">
                       <span className="font-bold text-gray-700 dark:text-gray-200">{name}</span>
                       <span className="text-xs text-red-500 font-bold">중복 감지</span>
                    </div>
                 ))}
              </div>
              <div className="flex gap-2">
                 <button 
                    onClick={() => confirmPantryCheck(selectedNames.filter(n => !pantryCheckModal.duplicates.includes(n)))} 
                    className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold text-sm hover:bg-green-700"
                 >
                    네, 빼고 넣을게요
                 </button>
                 <button 
                    onClick={() => confirmPantryCheck(selectedNames)} 
                    className="flex-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-xl font-bold text-sm hover:bg-gray-300"
                 >
                    그냥 다 넣기
                 </button>
              </div>
           </div>
        </div>
      )}
    </div>
  );
}

// --- RecipeView: 냉장고 털기 필터 & 임박 재료 추천 기능 탑재 ---
function RecipeView({ ingredients, onAddToCart, recipes, user }) {
  const [activeTab, setActiveTab] = useState('default'); 
  const [myRecipes, setMyRecipes] = useState([]);
  
  // 🟢 [New] 냉파 필터 상태
  const [isFridgeClearingMode, setIsFridgeClearingMode] = useState(false);

  // 리스트 필터링용 상태
  const [selectedIngredients, setSelectedIngredients] = useState([]);
  const [selectedRecipe, setSelectedRecipe] = useState(null);
  
  // 상세화면용 상태
  const [ingredientsToBuy, setIngredientsToBuy] = useState([]);
  const [servings, setServings] = useState(1); 
  const [isCookingMode, setIsCookingMode] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);

  // 1. 내 레시피 불러오기
  useEffect(() => {
    if(!user) return;
    const q = query(collection(db, `users/${user.uid}/recipes`));
    const unsub = onSnapshot(q, (snap) => {
        setMyRecipes(snap.docs.map(d => ({...d.data(), id: d.id, category: 'My'})));
    });
    return () => unsub();
  }, [user]);

  // 2. 레시피 열 때 '없는 재료'만 자동으로 선택 (스마트 체크)
  useEffect(() => {
    if (selectedRecipe) {
        // 내가 없는 재료만 true (구매 목록)
        const missing = selectedRecipe.ingredients.filter(ing => 
            !ingredients.some(myIng => matchIngredient(ing, myIng.name))
        );
        setIngredientsToBuy(missing);
    }
  }, [selectedRecipe, ingredients]);

  // 3. 재료명 매칭 헬퍼
  const matchIngredient = (r, u) => { 
      const rr = r.replace(/\s/g,'');
      const uu = u.replace(/\s/g,''); 
      if(rr === uu) return true; 
      return rr.includes(uu) || uu.includes(rr); 
  };

  // 4. 유통기한 임박도 계산 (3일 이내면 점수 높음)
  const getIngredientUrgency = (ingName) => {
    const matchedItems = ingredients.filter(i => matchIngredient(ingName, i.name));
    if (matchedItems.length === 0) return 0;
    
    // 하나라도 유통기한이 3일 이내라면 긴급(Danger)
    const hasDanger = matchedItems.some(i => {
       const today = new Date(); today.setHours(0,0,0,0);
       const exp = new Date(i.expiry); exp.setHours(0,0,0,0);
       const diff = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
       return diff >= 0 && diff <= 3;
    });
    return hasDanger ? 100 : 1; // 임박 재료는 가중치 100점 부여 (무조건 상단 노출)
  };

  const toggleIngredientToBuy = (ingName) => {
      if (ingredientsToBuy.includes(ingName)) {
          setIngredientsToBuy(prev => prev.filter(i => i !== ingName));
      } else {
          setIngredientsToBuy(prev => [...prev, ingName]);
      }
  };

  const extractAmountAndUnit = (ingName, measureText) => {
      if (!measureText) return { amount: 0, unit: 'g' };
      try {
        const regex = new RegExp(`${ingName}.*?([0-9.]+)\\s*(g|kg|ml|L|개|봉|t|T|컵|쪽|마리)`, 'i');
        const match = measureText.match(regex);
        if (match) {
            let amount = parseFloat(match[1]);
            amount = amount * servings;
            return { 
                amount: Number.isInteger(amount) ? amount : Number(amount.toFixed(1)), 
                unit: match[2] 
            };
        }
      } catch (e) { console.error("Regex parsing error", e); }
      return { amount: 0, unit: 'g' };
  };

  const handleAddSelectedToCart = () => {
      if(ingredientsToBuy.length === 0) {
          toast.error('담을 재료가 없습니다.');
          return;
      }
      let addedCount = 0;
      ingredientsToBuy.forEach(item => {
          const { amount, unit } = extractAmountAndUnit(item, selectedRecipe.measure);
          onAddToCart({ name: item, amount, unit });
          addedCount++;
      });
      toast.success(`${addedCount}개 재료를 장바구니에 담았습니다!`);
  };

  const scaleText = (text, factor) => {
     if (factor === 1 || !text) return text;
     return text.replace(/(\d+(\.\d+)?)/g, (match) => {
        const num = parseFloat(match);
        return Number.isInteger(num * factor) ? (num * factor) : (num * factor).toFixed(1);
     });
  };

  const toggleCookingMode = async () => {
     if (!isCookingMode) {
        try {
           if ('wakeLock' in navigator) {
              await navigator.wakeLock.request('screen');
              toast.success("화면 켜짐 유지 모드 ON 💡");
           }
        } catch(e) { console.log('Wake Lock Error', e); }
        setIsCookingMode(true);
        setCurrentStep(0);
     } else {
        setIsCookingMode(false);
     }
  };

  const addMyRecipe = async () => {
    const name = prompt("🍳 레시피 이름이 무엇인가요?");
    if(!name) return;
    const ingreds = prompt("🥕 필요한 재료를 쉼표(,)로 구분해 적어주세요\n(예: 김치, 돼지고기, 두부)");
    const steps = prompt("📝 조리법을 단계별로 적어주세요");
    try {
        await addDoc(collection(db, `users/${user.uid}/recipes`), {
            name, category: 'My',
            ingredients: ingreds ? ingreds.split(',').map(s=>s.trim()) : [],
            measure: ingreds || '',
            steps: steps ? [steps] : ['자유롭게 조리하세요!']
        });
        toast.success('나만의 레시피가 추가되었습니다!');
    } catch(e) { toast.error('저장 실패'); }
  };

  // 🟢 [Logic] 레시피 정렬 및 필터링 핵심 로직
  const allRecipes = activeTab === 'default' ? recipes : myRecipes;
  
  let matchedRecipes = allRecipes.map(recipe => {
      // 보유 재료 확인
      const existing = recipe.ingredients.filter(req => selectedIngredients.some(sel => matchIngredient(req, sel)));
      const missing = recipe.ingredients.filter(req => !selectedIngredients.some(sel => matchIngredient(req, sel)));
      
      // 긴급 점수 계산 (임박 재료 포함 시 점수 폭발적 증가)
      let urgencyScore = 0;
      // 내가 가진 재료들 중에서, 이 레시피에 쓰이는 것들의 긴급도 합산
      ingredients.forEach(myIng => {
          if (recipe.ingredients.some(req => matchIngredient(req, myIng.name))) {
              urgencyScore += getIngredientUrgency(myIng.name);
          }
      });
      
      return { ...recipe, existing, missing, urgencyScore, score: existing.length + urgencyScore };
  });

  // 냉파 필터가 켜져있으면, 유통기한 임박 재료(100점 이상)가 포함된 레시피만 남김
  if (isFridgeClearingMode) {
      matchedRecipes = matchedRecipes.filter(r => r.urgencyScore >= 100);
  }

  // 정렬: 점수 높은 순 (임박 재료 포함 > 보유 재료 많음)
  matchedRecipes.sort((a, b) => b.score - a.score);

  const toggleSelection = (name) => { if (selectedIngredients.includes(name)) setSelectedIngredients(selectedIngredients.filter(i => i !== name)); else setSelectedIngredients([...selectedIngredients, name]); };
  const toggleSelectAll = () => { if (selectedIngredients.length === ingredients.length && ingredients.length > 0) setSelectedIngredients([]); else setSelectedIngredients(ingredients.map(i => i.name)); };


  // [VIEW 1] 조리 모드
  if (isCookingMode && selectedRecipe) {
     const scaledSteps = selectedRecipe.steps.map(s => scaleText(s, servings));
     return (
        <div className="fixed inset-0 z-50 bg-gray-900 text-white flex flex-col animate-in fade-in duration-300">
           <div className="flex justify-between items-center p-6 border-b border-gray-700">
              <h2 className="text-xl font-bold truncate pr-4">{selectedRecipe.name} (Step {currentStep + 1}/{scaledSteps.length})</h2>
              <button onClick={toggleCookingMode} className="bg-red-600 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-1 hover:bg-red-700"><X size={16}/> 종료</button>
           </div>
           <div className="flex-1 flex items-center justify-center p-8 text-center">
              <div className="max-w-2xl">
                 <span className="inline-block bg-green-600 text-2xl font-bold rounded-full w-16 h-16 flex items-center justify-center mb-6 mx-auto shadow-lg shadow-green-900/50">{currentStep + 1}</span>
                 <p className="text-2xl md:text-4xl font-bold leading-relaxed whitespace-pre-wrap">{scaledSteps[currentStep]}</p>
              </div>
           </div>
           <div className="p-8 pb-10 flex justify-between items-center bg-gray-800">
              <button disabled={currentStep===0} onClick={()=>setCurrentStep(prev=>prev-1)} className="flex items-center gap-2 text-lg font-bold disabled:opacity-30 hover:text-green-400"><ChevronLeft size={30}/> 이전</button>
              <button disabled={currentStep===scaledSteps.length-1} onClick={()=>setCurrentStep(prev=>prev+1)} className="flex items-center gap-2 text-lg font-bold disabled:opacity-30 hover:text-green-400">다음 <ChevronRight size={30}/></button>
           </div>
        </div>
     );
  }

  // [VIEW 2] 상세 보기
  if (selectedRecipe) {
  return (
    <div className="p-4 pb-24 h-full bg-white flex flex-col overflow-y-auto">
      {/* 👇 sticky 제거하여 스크롤 시 자연스럽게 올라감 */}
      <div className="bg-white pb-4 border-b mb-4">
        <button onClick={() => { setSelectedRecipe(null); setServings(1); }} className="text-gray-500 flex items-center gap-2 mb-2 hover:text-green-600 font-bold">
                   <ArrowLeft size={20}/> 목록으로 돌아가기
               </button>
               <div className="flex justify-between items-end">
                  <h2 className="text-3xl font-bold text-gray-800">{selectedRecipe.name}</h2>
                  <button onClick={toggleCookingMode} className="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-md hover:bg-green-700 flex items-center gap-2 animate-pulse">
                      <MonitorPlay size={18}/> 요리 시작
                  </button>
               </div>
               <div className="flex gap-2 mt-2">
                   <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">{selectedRecipe.category}</span>
                   <span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">재료 {selectedRecipe.ingredients.length}개</span>
               </div>
            </div>
            
            <div className="bg-green-50 p-4 rounded-2xl mb-6 border border-green-100 flex items-center justify-between">
               <span className="font-bold text-green-800 flex items-center gap-2"><Users size={18}/> 기준 인원</span>
               <div className="flex items-center bg-white rounded-lg shadow-sm">
                  <button onClick={() => setServings(Math.max(1, servings - 1))} className="p-2 px-3 hover:bg-gray-100 rounded-l-lg">-</button>
                  <span className="px-2 min-w-[4rem] text-center font-bold text-lg whitespace-nowrap">{servings}인분</span>
                  <button onClick={() => setServings(servings + 1)} className="p-2 px-3 hover:bg-gray-100 rounded-r-lg">+</button>
               </div>
            </div>

            <div className="mb-8">
                <div className="flex justify-between items-center mb-3">
                    <h3 className="text-lg font-bold flex items-center gap-2"><ShoppingCart size={18}/> 재료 선택</h3>
                    <button onClick={handleAddSelectedToCart} className="text-xs bg-green-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-md hover:bg-green-700 transition-colors flex items-center gap-1">
                        <Plus size={12}/> 선택한 {ingredientsToBuy.length}개 장바구니 담기
                    </button>
                </div>
                <div className="bg-gray-50 p-4 rounded-2xl text-sm text-gray-700 leading-relaxed mb-4 whitespace-pre-line">
                    {scaleText(selectedRecipe.measure, servings)}
                </div>
                <div className="flex flex-wrap gap-2">
                    {selectedRecipe.ingredients.map((ing, i) => {
                        const have = ingredients.some(myIng => matchIngredient(ing, myIng.name));
                        const willBuy = ingredientsToBuy.includes(ing);
                        return (
                            <button key={i} onClick={() => toggleIngredientToBuy(ing)} className={`px-3 py-1.5 rounded-full text-xs font-medium border flex items-center gap-1 transition-all ${have ? 'bg-gray-100 text-gray-400 border-gray-200 line-through decoration-1' : willBuy ? 'bg-blue-50 border-blue-500 text-blue-700 ring-1 ring-blue-500' : 'bg-white text-gray-500 border-gray-200 hover:border-blue-300'}`}>
                                {willBuy && !have && <Check size={10} strokeWidth={3} />}
                                {ing}
                                {have && <span className="text-[10px] ml-1">(보유)</span>}
                            </button>
                        );
                    })}
                </div>
                <p className="text-[10px] text-gray-400 mt-2 ml-1 text-right">* 파란색 테두리가 장바구니에 담길 재료입니다.</p>
            </div>

            <div className="mb-8">
               <h3 className="text-lg font-bold flex items-center gap-2 mb-4"><ChefHat size={18}/> 조리 순서</h3>
               <div className="space-y-4">
                   {selectedRecipe.steps && selectedRecipe.steps.length > 0 ? (
                       selectedRecipe.steps.map((step, index) => (
                           <div key={index} className="flex gap-4">
                               <div className="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-sm shadow-md">{index + 1}</div>
                               <div className="flex-1 bg-white border border-gray-100 p-4 rounded-2xl shadow-sm text-gray-700 leading-relaxed">
                                   {scaleText(step, servings)}
                               </div>
                           </div>
                       ))
                   ) : <div className="text-center text-gray-400 py-10 bg-gray-50 rounded-2xl">조리 순서 정보가 없습니다.</div>}
               </div>
            </div>
        </div>
      );
  }

  // [VIEW 3] 목록 화면
  return (
      <div className="p-4 pb-24 h-full flex flex-col bg-white">
        <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold">오늘 뭐 먹지?</h2>
            <div className="flex gap-2">
                {/* 🟢 [New] 냉장고 털기 필터 버튼 */}
                <button 
                    onClick={() => setIsFridgeClearingMode(!isFridgeClearingMode)} 
                    className={`px-3 py-1.5 text-xs font-bold rounded-lg border transition-all flex items-center gap-1 ${isFridgeClearingMode ? 'bg-red-100 text-red-600 border-red-200' : 'bg-white text-gray-500 border-gray-200'}`}
                >
                    <AlertCircle size={14} /> 냉장고 털기 {isFridgeClearingMode ? 'ON' : 'OFF'}
                </button>
                <div className="flex bg-gray-100 rounded-lg p-1">
                    <button onClick={() => setActiveTab('default')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${activeTab === 'default' ? 'bg-white shadow-sm text-green-600' : 'text-gray-400'}`}>추천</button>
                    <button onClick={() => setActiveTab('my')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${activeTab === 'my' ? 'bg-white shadow-sm text-green-600' : 'text-gray-400'}`}>MY</button>
                </div>
            </div>
        </div>

        {activeTab === 'my' && (
            <button onClick={addMyRecipe} className="w-full py-3 mb-4 border-2 border-dashed border-green-300 text-green-600 rounded-xl font-bold hover:bg-green-50 transition-colors flex items-center justify-center gap-2">
                <Plus size={18}/> 새 레시피 등록하기
            </button>
        )}

        <div className="mb-6">
            <div className="flex justify-between mb-2">
                <span className="text-xs font-bold text-gray-500">냉장고 재료 선택</span>
                <button onClick={toggleSelectAll} className="text-xs text-green-600 font-bold">전체선택</button>
            </div>
            <div className="flex flex-wrap gap-2">
                {ingredients.map(item => (
                    <button key={item.id} onClick={() => toggleSelection(item.name)} className={`px-3 py-1.5 rounded-full text-xs border transition-all ${selectedIngredients.includes(item.name) ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-500 border-gray-200'}`}>
                        {item.name}
                    </button>
                ))}
            </div>
        </div>

        <div className="flex-1 overflow-y-auto space-y-3">
            {matchedRecipes.length > 0 ? matchedRecipes.map((recipe, idx) => (
                <div key={idx} onClick={() => setSelectedRecipe(recipe)} className={`bg-white p-4 rounded-xl border shadow-sm hover:border-green-400 cursor-pointer transition-all ${recipe.urgencyScore >= 100 ? 'border-red-200 bg-red-50/30' : 'border-gray-100'}`}>
                    <div className="flex justify-between items-start">
                        <h3 className="font-bold text-gray-800 flex items-center gap-2">
                            {recipe.name}
                            {/* 🔥 임박 재료 뱃지 */}
                            {recipe.urgencyScore >= 100 && <span className="text-[9px] bg-red-500 text-white px-1.5 py-0.5 rounded-full animate-pulse">임박재료!</span>}
                        </h3>
                        <div className="flex gap-1">
                           {recipe.score > 0 && <span className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold">{recipe.existing.length}개 일치</span>}
                        </div>
                    </div>
                    <p className="text-xs text-gray-400 mt-1 truncate">{recipe.measure}</p>
                </div>
            )) : (
                <div className="text-center py-20 text-gray-400">
                    {isFridgeClearingMode ? 
                        <><AlertCircle className="mx-auto mb-2 text-gray-300"/>임박한 재료로 만들 수 있는<br/>레시피가 없어요 🥲</> : 
                        "등록된 레시피가 없습니다."
                    }
                </div>
            )}
        </div>
      </div>
  );
}
  
// --- NEW: 실제 데이터 기반 통계 뷰 (원클릭 재구매 버튼 추가됨) ---
function InsightsView({ ingredients, onAddToCart, history, onResetHistory }) {
  const totalUsed = history.filter(h => h.action === 'used').reduce((sum, item) => sum + (item.price || 0), 0);
  const totalWasted = history.filter(h => h.action === 'wasted').reduce((sum, item) => sum + (item.price || 0), 0);
  const rawSavings = Math.round(totalUsed * 0.6);
  const netSavings = rawSavings - totalWasted;
  
  const usageCounts = history.filter(h => h.action === 'used').reduce((acc, item) => {
      acc[item.name] = (acc[item.name] || 0) + 1;
      return acc;
  }, {});
  const rankedItems = Object.entries(usageCounts).sort(([,a], [,b]) => b - a).slice(0, 5);
  const formatMoney = (amount) => new Intl.NumberFormat('ko-KR').format(amount);

  return (
    <div className="p-4 pb-20 animate-in fade-in duration-500">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-lg font-bold flex items-center gap-2 text-gray-800">
          <BarChart2 className="text-green-600" /> 통계 및 분석
        </h2>
        <button onClick={onResetHistory} className="text-xs bg-gray-100 text-gray-500 px-3 py-1.5 rounded-lg flex items-center gap-1 hover:bg-red-50 hover:text-red-600 transition-colors">
          <RefreshCcw size={12} /> 기록 초기화
        </button>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      
          {/* 카드 1: 절약 금액 */}
          <div className={`p-6 rounded-3xl shadow-lg text-white relative overflow-hidden transition-colors ${netSavings >= 0 ? 'bg-gradient-to-br from-green-500 to-green-700' : 'bg-gradient-to-br from-red-500 to-red-700'}`}>
            <div className="absolute top-0 right-0 p-8 opacity-10"><DollarSign size={100} /></div>
            <div className="relative z-10">
              <h3 className="font-medium text-green-100 mb-1 flex items-center gap-2">이번 달 순수 절약</h3>
              <div className="text-3xl font-bold mb-4 flex items-baseline gap-1">
                {formatMoney(netSavings)}<span className="text-sm font-normal">원</span>
              </div>
              <div className="bg-white/20 rounded-xl p-3 backdrop-blur-sm text-sm space-y-2">
                 <div className="flex justify-between"><span>+사용</span><span>{formatMoney(rawSavings)}</span></div>
                 <div className="flex justify-between text-red-100"><span>-폐기</span><span>{formatMoney(totalWasted)}</span></div>
              </div>
            </div>
          </div>

          {/* 카드 2: 현재 상태 */}
          <div className="bg-white p-5 rounded-2xl border shadow-sm flex flex-col justify-center">
            <h3 className="text-sm font-bold text-gray-500 mb-3 flex items-center gap-1"><PieChart size={14} /> 냉장고 현황</h3>
            <div className="flex items-center justify-between px-2">
                <div className="text-center"><div className="text-2xl font-bold text-green-600">{ingredients.length}</div><div className="text-xs text-gray-400">보관</div></div>
                <div className="h-8 w-[1px] bg-gray-200"></div>
                <div className="text-center"><div className="text-2xl font-bold text-blue-500">{history.filter(h=>h.action==='used').length}</div><div className="text-xs text-gray-400">소비</div></div>
                <div className="h-8 w-[1px] bg-gray-200"></div>
                <div className="text-center"><div className="text-2xl font-bold text-red-500">{history.filter(h=>h.action==='wasted').length}</div><div className="text-xs text-gray-400">폐기</div></div>
            </div>
          </div>

          {/* 카드 3: 자주 먹은 재료 (여기에 + 버튼 추가됨) */}
          <div className="bg-white p-5 rounded-2xl border shadow-sm">
            <h3 className="text-sm font-bold text-gray-500 mb-4 flex items-center gap-1"><TrendingUp size={14} /> 자주 먹은 재료</h3>
            <div className="space-y-3 max-h-40 overflow-y-auto pr-1">
              {rankedItems.length > 0 ? rankedItems.map(([name, count], idx) => (
                <div key={idx} className="flex justify-between items-center text-xs">
                    <span className="font-bold text-gray-700">{idx+1}. {name}</span>
                    <div className="flex items-center gap-2">
                        <span className="text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{count}회</span>
                        {/* 👇 [추가됨] 원클릭 장바구니 버튼 */}
                        <button onClick={() => onAddToCart(name)} className="p-1 bg-green-50 text-green-600 rounded hover:bg-green-100 transition-colors" title="장바구니 담기">
                            <Plus size={14} />
                        </button>
                    </div>
                </div>
              )) : <div className="text-center text-gray-400 text-xs py-4">기록 없음</div>}
            </div>
          </div>

      </div>
    </div>
  );
}

// 👇 이 코드를 파일 맨 마지막에 붙여넣으세요.

function NavBtn({ active, onClick, icon, label, count }) {
  return (
    <button onClick={onClick} className={`flex flex-col items-center gap-1 relative ${active ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500'}`}>
      <div className="relative">
        {React.cloneElement(icon, { size: 24, strokeWidth: active ? 2.5 : 2 })}
        {count > 0 && <span className="absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center ring-1 ring-white dark:ring-gray-800">{count}</span>}
      </div>
      <span className="text-[10px] font-medium">{label}</span>
    </button>
  );
}

// 🌟 [신규] 재료 정보 수정 모달
function EditIngredientModal({ item, onClose, onUpdate }) {
  const [data, setData] = useState({ ...item, expiry: item.expiry ? new Date(item.expiry).toISOString().split('T')[0] : '' });
  const handleSubmit = () => {
    onUpdate(item.id, { ...data, expiry: new Date(data.expiry), price: Number(data.price), amount: Number(data.amount) });
    onClose(); toast.success('정보가 수정되었습니다! 📝');
  };
  return (
    <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-in fade-in" onClick={onClose}>
      <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
        <h2 className="text-xl font-bold mb-4">재료 정보 수정</h2>
        <div className="space-y-3">
          <div><label className="text-xs text-gray-500">이름</label><input type="text" value={data.name} onChange={e=>setData({...data, name: e.target.value})} className="w-full p-2 border rounded-lg font-bold"/></div>
          <div><label className="text-xs text-gray-500">위치 (LG 4도어)</label>
            <select value={data.location || ''} onChange={e=>setData({...data, location: e.target.value})} className="w-full p-2 border rounded-lg">
                <option value="">(선택 안함)</option>
                {Object.values(ZONES).map(zone => (
                    <option key={zone} value={zone}>{zone}</option>
                ))}
            </select></div>
          <div className="flex gap-2"><div className="flex-1"><label className="text-xs text-gray-500">유통기한</label><input type="date" value={data.expiry} onChange={e=>setData({...data, expiry: e.target.value})} className="w-full p-2 border rounded-lg"/></div><div className="flex-1"><label className="text-xs text-gray-500">가격</label><input type="number" value={data.price} onChange={e=>setData({...data, price: e.target.value})} className="w-full p-2 border rounded-lg"/></div></div>
        </div>
        <div className="flex gap-2 mt-3">
            <div className="flex-1">
                <label className="text-xs text-gray-500">용량/수량</label>
                <input type="number" value={data.amount || ''} onChange={e=>setData({...data, amount: e.target.value})} className="w-full p-2 border rounded-lg"/>
            </div>
            <div className="flex-1">
                <label className="text-xs text-gray-500">단위</label>
                <input type="text" value={data.unit || ''} onChange={e=>setData({...data, unit: e.target.value})} className="w-full p-2 border rounded-lg"/>
            </div>
        </div>
        <div className="flex gap-2 mt-6"><button onClick={onClose} className="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">취소</button><button onClick={handleSubmit} className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold">저장하기</button></div>
      </div>
    </div>
  );
}

// 🌟 [신규] LG 4도어 스타일 시각적 냉장고 지도 (세분화된 레이아웃)
function FridgeMap({ ingredients, onItemClick }) {
  const getItems = (zoneName) => ingredients.filter(i => i.location === zoneName);

  const renderItems = (zoneName, label = null) => {
    const items = getItems(zoneName);
    return (
      <div className="flex flex-col h-full overflow-hidden relative">
        {/* 🌟 라벨을 위쪽에 고정된 블록으로 배치하여 재료와 겹치지 않게 함 */}
        {label && <div className="text-[8px] text-gray-400 font-bold px-1 py-0.5 bg-white/50 w-full border-b border-gray-100">{label}</div>}
        <div className="flex flex-wrap content-start gap-1 overflow-y-auto p-1 min-h-[50px] flex-1">
          {items.map(item => (
            <button key={item.id} onClick={(e) => { e.stopPropagation(); onItemClick(item); }} className="bg-white border shadow-sm rounded px-1.5 py-0.5 text-[9px] font-bold text-gray-700 truncate max-w-full hover:bg-green-100 flex items-center gap-1 shrink-0">
              <div className={`w-1.5 h-1.5 rounded-full ${new Date(item.expiry) < new Date() ? 'bg-red-500' : 'bg-green-400'}`} />
              {item.name}
            </button>
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="p-2 animate-in fade-in zoom-in duration-300 pb-20">
      {/* 🌟 전체 냉장고 프레임 */}
      <div className="border-[8px] border-gray-300 rounded-[30px] shadow-2xl bg-gray-200 overflow-hidden flex flex-col h-[85vh] min-h-[750px]">
        
        {/* 1️⃣ 상단: 냉장실 (60% 높이) */}
        <div className="flex-[5.5] flex bg-white border-b-[6px] border-gray-300">
            {/* 좌측 도어 */}
            <div className="w-[18%] border-r-2 border-gray-100 bg-blue-50/10 flex flex-col">
                <div className="text-[9px] text-center text-gray-400 font-bold py-1 bg-gray-50 border-b">좌측 도어</div>
                <div className="flex-1 flex flex-col">
                    <div className="flex-1 border-b border-gray-100">{renderItems(ZONES.FRIDGE_DOOR_LEFT_1, '상')}</div>
                    <div className="flex-1 border-b border-gray-100">{renderItems(ZONES.FRIDGE_DOOR_LEFT_2, '중')}</div>
                    <div className="flex-1">{renderItems(ZONES.FRIDGE_DOOR_LEFT_3, '하')}</div>
                </div>
            </div>
            <div className="flex-1 flex flex-col border-r-2 border-gray-100">
                <div className="flex-[3] flex flex-col">
                    <div className="flex-1 border-b border-dashed border-gray-200">{renderItems(ZONES.FRIDGE_MAIN_1, '상단 선반')}</div>
                    <div className="flex-1 border-b border-dashed border-gray-200">{renderItems(ZONES.FRIDGE_MAIN_2, '중단 선반')}</div>
                    <div className="flex-1 border-b border-dashed border-gray-200">{renderItems(ZONES.FRIDGE_MAIN_3, '하단 선반')}</div>
                </div>
                <div className="h-[12%] flex border-t-2 border-gray-200 bg-gray-50">
                    <div className="flex-1 border-r border-gray-200">{renderItems(ZONES.FRIDGE_MULTI_1, '멀티(좌)')}</div>
                    <div className="flex-1">{renderItems(ZONES.FRIDGE_MULTI_2, '멀티(우)')}</div>
                </div>
                <div className="h-[18%] flex border-t-2 border-gray-200 bg-green-50/20">
                     <div className="flex-1 border-r border-green-100">{renderItems(ZONES.FRIDGE_FRESH_1, '🥬 신선야채(좌)')}</div>
                     <div className="flex-1">{renderItems(ZONES.FRIDGE_FRESH_2, '🥬 신선야채(우)')}</div>
                </div>
            </div>
            <div className="w-[18%] bg-blue-50/10 flex flex-col">
                <div className="text-[9px] text-center text-gray-400 font-bold py-1 bg-gray-50 border-b">우측 도어</div>
                 <div className="flex-1 flex flex-col">
                    <div className="flex-1 border-b border-gray-100">{renderItems(ZONES.FRIDGE_DOOR_RIGHT_1, '상')}</div>
                    <div className="flex-1 border-b border-gray-100">{renderItems(ZONES.FRIDGE_DOOR_RIGHT_2, '중')}</div>
                    <div className="flex-1">{renderItems(ZONES.FRIDGE_DOOR_RIGHT_3, '하')}</div>
                </div>
            </div>
        </div>

        {/* 2️⃣ 하단: 냉동실 (기존 flex-[2] -> flex-[4.5]로 대폭 확대) */}
        <div className="flex-[4.5] flex bg-blue-100/10">
            {/* 좌측 냉동 */}
            <div className="flex-1 flex border-r-4 border-gray-300">
                <div className="w-[25%] border-r border-blue-100 bg-blue-50/30 flex flex-col">
                     <div className="flex-1 border-b border-blue-100">{renderItems(ZONES.FREEZER_LEFT_DOOR_1, '도어(상)')}</div>
                     <div className="flex-1">{renderItems(ZONES.FREEZER_LEFT_DOOR_2, '도어(하)')}</div>
                </div>
                {/* 🌟 서랍 3단 분할 코드 (테두리 점선으로 구분) */}
                <div className="flex-1 flex flex-col">
                    <div className="flex-1 border-b-2 border-dashed border-blue-200">{renderItems(ZONES.FREEZER_LEFT_1, '서랍 1 (상)')}</div>
                    <div className="flex-1 border-b-2 border-dashed border-blue-200">{renderItems(ZONES.FREEZER_LEFT_2, '서랍 2 (중)')}</div>
                    <div className="flex-1">{renderItems(ZONES.FREEZER_LEFT_3, '서랍 3 (하)')}</div>
                </div>
            </div>

            {/* 우측 냉동 */}
            <div className="flex-1 flex">
                 {/* 🌟 서랍 3단 분할 코드 */}
                 <div className="flex-1 flex flex-col border-r border-blue-100">
                    <div className="flex-1 border-b-2 border-dashed border-blue-200">{renderItems(ZONES.FREEZER_RIGHT_1, '서랍 1 (상)')}</div>
                    <div className="flex-1 border-b-2 border-dashed border-blue-200">{renderItems(ZONES.FREEZER_RIGHT_2, '서랍 2 (중)')}</div>
                    <div className="flex-1">{renderItems(ZONES.FREEZER_RIGHT_3, '서랍 3 (하)')}</div>
                </div>
                <div className="w-[25%] bg-blue-50/30 flex flex-col">
                     <div className="flex-1 border-b border-blue-100">{renderItems(ZONES.FREEZER_RIGHT_DOOR_1, '도어(상)')}</div>
                     <div className="flex-1">{renderItems(ZONES.FREEZER_RIGHT_DOOR_2, '도어(하)')}</div>
                </div>
            </div>
        </div>
      </div>
      
      {/* 3️⃣ 실온 / 팬트리 (기존 유지) */}
      <div className="mt-4 bg-orange-50 border-2 border-dashed border-orange-200 rounded-xl p-3 min-h-[100px]">
          <h3 className="text-xs font-bold text-orange-600 mb-2">🏠 실온 보관 / 팬트리</h3>
          <div className="flex flex-wrap gap-2">
            {renderItems(ZONES.PANTRY, null).props.children[1]}
          </div>
      </div>
    </div>
  );
}
       